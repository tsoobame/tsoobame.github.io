<!DOCTYPE html><html lang="en" style="height:100%"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Understanding data loader</title><meta name="next-head-count" content="3"/><link rel="stylesheet" href="https://unpkg.com/prism-themes@1.9.0/themes/prism-vsc-dark-plus.min.css"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-Z67DVHFVCM"></script><script async="" src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.0/mermaid.min.js"></script><script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-Z67DVHFVCM', {
              page_path: window.location.pathname,
            });
          </script><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-fc37f78f7b08c779.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/framework-5429a50ba5373c56.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/main-e5e3028d01be4a56.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/_app-2da26c76ee71effa.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/08d5973c-93551e6c2b860ae6.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/181-06ac36073c0625e7.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/672-6fb3b021c17f5fb2.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-a3dc28cc2acd48c8.js" defer="" crossorigin=""></script><script src="/_next/static/otESvGl4OI2fDtGK8bZWs/_buildManifest.js" defer="" crossorigin=""></script><script src="/_next/static/otESvGl4OI2fDtGK8bZWs/_ssgManifest.js" defer="" crossorigin=""></script><style id="jss-server-side">.jss1 {
  background: linear-gradient(90deg, #00766c, #0077c2);
}
.jss3 {
  overflow-x: auto;
  justify-content: space-between;
}
.jss4 {
  padding: 8px;
  flex-shrink: 0;
}
.jss5 {
  top: 0;
  left: 0;
  right: 0;
  width: 100%;
  z-index: 1;
  position: fixed;
}
.jss6 {
  color: #FFFFFF;
  width: 100%;
  bottom: 0;
  padding: 16px 0px;
  z-index: 99;
  position: fixed;
  background: linear-gradient(90deg, #00766c, #0077c2);
}</style></head><body style="padding:0;margin:0;min-height:100%"><div id="__next"><style data-emotion="css 1a51u83">.css-1a51u83{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:static;background-color:#26a69a;color:#FFFFFF;}</style><style data-emotion="css 1rhdqfh">.css-1rhdqfh{background-color:#FFFFFF;color:#263238;-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;box-shadow:0px 2px 4px -1px rgba(0,0,0,0.2),0px 4px 5px 0px rgba(0,0,0,0.14),0px 1px 10px 0px rgba(0,0,0,0.12);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:static;background-color:#26a69a;color:#FFFFFF;}</style><header class="MuiPaper-root MuiPaper-elevation MuiPaper-elevation4 MuiAppBar-root MuiAppBar-colorPrimary MuiAppBar-positionStatic jss5 css-1rhdqfh" style="padding:0"><style data-emotion="css i6s8oy">.css-i6s8oy{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding-left:16px;padding-right:16px;min-height:56px;}@media (min-width:600px){.css-i6s8oy{padding-left:24px;padding-right:24px;}}@media (min-width:0px){@media (orientation: landscape){.css-i6s8oy{min-height:48px;}}}@media (min-width:600px){.css-i6s8oy{min-height:64px;}}</style><div class="MuiToolbar-root MuiToolbar-gutters MuiToolbar-regular jss1 css-i6s8oy"><style data-emotion="css 18zcnv2">.css-18zcnv2{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1.5rem;line-height:1.334;letter-spacing:0em;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:inherit;}</style><h2 class="MuiTypography-root MuiTypography-h5 MuiTypography-alignCenter MuiTypography-noWrap jss2 css-18zcnv2"><a color="inherit" href="/" style="color:white;text-decoration:none">tsoobame</a></h2><style data-emotion="css i9gxme">.css-i9gxme{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><div class="MuiBox-root css-i9gxme"><style data-emotion="css 4fvm0a">.css-4fvm0a{font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#26a69a;color:#FFFFFF;}.css-4fvm0a:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(38, 166, 154, 0.04);}@media (hover: none){.css-4fvm0a:hover{background-color:transparent;}}.css-4fvm0a.Mui-disabled{color:rgba(0, 0, 0, 0.26);}</style><style data-emotion="css ye6gas">.css-ye6gas{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#26a69a;color:#FFFFFF;}.css-ye6gas::-moz-focus-inner{border-style:none;}.css-ye6gas.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-ye6gas{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-ye6gas:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(38, 166, 154, 0.04);}@media (hover: none){.css-ye6gas:hover{background-color:transparent;}}.css-ye6gas.Mui-disabled{color:rgba(0, 0, 0, 0.26);}</style><button class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary css-ye6gas" tabindex="0" type="button"><a href="/blog" color="inherit" style="color:white;text-decoration:none">Blog</a></button><button class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary css-ye6gas" tabindex="0" type="button"><a href="/about" color="inherit" style="color:white;text-decoration:none">About</a></button><button class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary css-ye6gas" tabindex="0" type="button"><a href="/projects" color="inherit" style="color:white;text-decoration:none">Projects</a></button><button class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary css-ye6gas" tabindex="0" type="button"><a href="/recommended-resources" color="inherit" style="color:white;text-decoration:none">Resources</a></button></div></div></header><div class="MuiBox-root css-0" style="position:relative;width:90%;padding-left:24px;padding-right:24px;margin-top:80px;padding-bottom:90px;z-index:0;min-height:100%"><div class="MuiBox-root css-0" style="width:auto;padding:12px"><style data-emotion="css 15bqboc">.css-15bqboc{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;width:100%;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:start;-ms-flex-pack:start;-webkit-justify-content:flex-start;justify-content:flex-start;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}</style><div class="MuiGrid-root MuiGrid-container css-15bqboc"><style data-emotion="css 13ps8n2">.css-13ps8n2{box-sizing:border-box;margin:0;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;}@media (min-width:600px){.css-13ps8n2{-webkit-flex-basis:100%;-ms-flex-preferred-size:100%;flex-basis:100%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:100%;}}@media (min-width:900px){.css-13ps8n2{-webkit-flex-basis:25%;-ms-flex-preferred-size:25%;flex-basis:25%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:25%;}}@media (min-width:1200px){.css-13ps8n2{-webkit-flex-basis:25%;-ms-flex-preferred-size:25%;flex-basis:25%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:25%;}}@media (min-width:1536px){.css-13ps8n2{-webkit-flex-basis:25%;-ms-flex-preferred-size:25%;flex-basis:25%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:25%;}}</style><div class="MuiGrid-root MuiGrid-item MuiGrid-grid-sm-12 MuiGrid-grid-md-3 css-13ps8n2" style="padding:6px"><div><style data-emotion="css t1nuxs">.css-t1nuxs{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1.5rem;line-height:1.334;letter-spacing:0em;margin-bottom:0.35em;}</style><h5 class="MuiTypography-root MuiTypography-h5 MuiTypography-gutterBottom css-t1nuxs">Posts </h5><ul style="list-style-type:none"><li><style data-emotion="css 9l3uo3">.css-9l3uo3{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class="MuiTypography-root MuiTypography-body1 css-9l3uo3"><a href="/blog/data-loader.html" style="text-decoration:none;color:gray">Understanding data loader</a></p></li><li><p class="MuiTypography-root MuiTypography-body1 css-9l3uo3"><a href="/blog/graphql-schema-stitching.html" style="text-decoration:none;color:gray">Graphql Schema Stitching</a></p></li><li><p class="MuiTypography-root MuiTypography-body1 css-9l3uo3"><a href="/blog/shape-vs-optionality.html" style="text-decoration:none;color:gray">Decomplecting shape and optionality</a></p></li><li><p class="MuiTypography-root MuiTypography-body1 css-9l3uo3"><a href="/blog/docker-registry-mirror.html" style="text-decoration:none;color:gray">Local docker registry mirror</a></p></li><li><p class="MuiTypography-root MuiTypography-body1 css-9l3uo3"><a href="/blog/function-call-cascading.html" style="text-decoration:none;color:gray">Function call cascading considered harmful</a></p></li><li><p class="MuiTypography-root MuiTypography-body1 css-9l3uo3"><a href="/blog/talk-think-code.html" style="text-decoration:none;color:gray">Talk, think, code</a></p></li></ul></div></div><style data-emotion="css 1xd5sck">.css-1xd5sck{box-sizing:border-box;margin:0;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-basis:100%;-ms-flex-preferred-size:100%;flex-basis:100%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:100%;}@media (min-width:600px){.css-1xd5sck{-webkit-flex-basis:100%;-ms-flex-preferred-size:100%;flex-basis:100%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:100%;}}@media (min-width:900px){.css-1xd5sck{-webkit-flex-basis:75%;-ms-flex-preferred-size:75%;flex-basis:75%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:75%;}}@media (min-width:1200px){.css-1xd5sck{-webkit-flex-basis:75%;-ms-flex-preferred-size:75%;flex-basis:75%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:75%;}}@media (min-width:1536px){.css-1xd5sck{-webkit-flex-basis:75%;-ms-flex-preferred-size:75%;flex-basis:75%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:75%;}}</style><div class="MuiGrid-root MuiGrid-item MuiGrid-grid-xs-12 MuiGrid-grid-md-9 css-1xd5sck"><img src="https://res.cloudinary.com/ddkok43g3/image/upload/t_Banner 16:9/v1711551544/data-loader.jpg" alt="Understanding data loader" width="100%"/><p class="MuiTypography-root MuiTypography-body1 css-9l3uo3">‚è± <!-- -->8 min read</p><div class="MuiBox-root css-0"><style data-emotion="css 6s8q25">.css-6s8q25{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:3rem;line-height:1.167;letter-spacing:0em;margin-bottom:0.35em;}</style><h3 class="MuiTypography-root MuiTypography-h3 MuiTypography-gutterBottom css-6s8q25" style="margin-top:24px">Understanding the Dataloader</h3>
<style data-emotion="css wje1bd">.css-wje1bd{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;margin-bottom:16px;}</style><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Dataloader is one of the packages I find more useful and smart from the ones I have in my toolbox.</p>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">I am going to set up a obvious naive example and follow the process to build a simple dataloader to understand its beauty and how useful it is.</p>
<style data-emotion="css gtvj52">.css-gtvj52{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:2.125rem;line-height:1.235;letter-spacing:0.00735em;margin-bottom:0.35em;}</style><h4 class="MuiTypography-root MuiTypography-h4 MuiTypography-gutterBottom css-gtvj52" style="margin-top:24px">About the project</h4>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">We are going to create a view and api over a social network. Our users relations are:</p>
<div class="remark-highlight"><pre class="language-text"><code class="language-text">User 1 friend of [ 2, 3 ]
User 2 friend of [ 1, 3 ]
User 3 friend of [ 1, 2, 4 ]
User 4 friend of [ 3, 5 ]
User 5 friend of [ 4 ]</code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">The view can show the relation between users and their friends. We can show N levels of their friendship. We are not goint to look much at it in this post.</p>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Users data can be found here.</p>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">The only dependency will be express.</p>
<h4 class="MuiTypography-root MuiTypography-h4 MuiTypography-gutterBottom css-gtvj52" style="margin-top:24px">Initial Setup</h4>
<h5 class="MuiTypography-root MuiTypography-h5 MuiTypography-gutterBottom css-t1nuxs" style="margin-top:24px">datasource.js</h5>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">The datasource allows us to retrieve one or multiple users by id. Contract is not random, it is already based on the real dataloader so there will be minimal changes over the course of the post. Data is defined in a file within the project. Code is pretty simple:</p>
<div class="remark-highlight"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./users.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">getUsersFromFile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ids</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span>
  ids<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> users<span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">u</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> u<span class="token punctuation">.</span><span class="token property-access">id</span> <span class="token operator">===</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadMany</span><span class="token punctuation">(</span><span class="token parameter">ids</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">GET /users?ids=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ids<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token function">getUsersFromFile</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">loadMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  load<span class="token punctuation">,</span>
  loadMany<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">The only interesting method is loadMany. We will print the requests to the simulated service so we can check the console. There will be a delay to resolve the promise, so we can simulate better and understand why dataloader is so good.</p>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">A very important requirement is that data needs to be returned to the caller in the right order and all elements need to be returned (same length of ids and results arrays). This will be clear when we put in place the dataloader.</p>
<h5 class="MuiTypography-root MuiTypography-h5 MuiTypography-gutterBottom css-t1nuxs" style="margin-top:24px">resolver.js</h5>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Resolver will use the datasource received by parameter to load friendship data about users. It can receive the levels of friends we want to get, so it will use a recursive approach to load friends of friends until all levels are fetched.</p>
<div class="remark-highlight"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getFriends</span><span class="token punctuation">(</span><span class="token parameter">datasource<span class="token punctuation">,</span> user<span class="token punctuation">,</span> levels</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>levels <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> user<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> user<span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> friends <span class="token operator">=</span> <span class="token keyword control-flow">await</span> datasource<span class="token punctuation">.</span><span class="token method function property-access">loadMany</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token property-access">friends</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token spread operator">...</span>user<span class="token punctuation">,</span>
    <span class="token literal-property property">friends</span><span class="token operator">:</span> <span class="token keyword control-flow">await</span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">all</span><span class="token punctuation">(</span>
      friends<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token function">getFriends</span><span class="token punctuation">(</span>datasource<span class="token punctuation">,</span> f<span class="token punctuation">,</span> levels <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getUserWithFriends</span><span class="token punctuation">(</span><span class="token parameter">datasource<span class="token punctuation">,</span> id<span class="token punctuation">,</span> levels <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> datasource<span class="token punctuation">.</span><span class="token method function property-access">load</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token function">getFriends</span><span class="token punctuation">(</span>datasource<span class="token punctuation">,</span> user<span class="token punctuation">,</span> levels<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span> getUserWithFriends <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">It uses a brute force approach on purpose. The code is simple but far away from being optimal. In one method it looks obvious, but sometimes, when we are building graphql or similar apis, or complex workflows we might be doing exactly this kind of brute force requests.</p>
<h5 class="MuiTypography-root MuiTypography-h5 MuiTypography-gutterBottom css-t1nuxs" style="margin-top:24px">view.js</h5>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Nothing advanced. Just render users friends in a nested way.</p>
<div class="remark-highlight"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div style=&quot;padding-left: 12px;background-color:#def&quot;&gt; </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
    user<span class="token punctuation">.</span><span class="token property-access">friends</span> <span class="token operator">?</span> user<span class="token punctuation">.</span><span class="token property-access">friends</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">u</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token function">render</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
  <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> &lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  render<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<h5 class="MuiTypography-root MuiTypography-h5 MuiTypography-gutterBottom css-t1nuxs" style="margin-top:24px">server.js</h5>
<div class="remark-highlight"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> datasource <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./datasource&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> resolver <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./resolver&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./view&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/user-with-friends/:id</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token property-access">params</span><span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> levels <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token property-access">query</span><span class="token punctuation">.</span><span class="token property-access">levels</span> <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> resolver<span class="token punctuation">.</span><span class="token method function property-access">getUserWithFriends</span><span class="token punctuation">(</span>datasource<span class="token punctuation">,</span> id<span class="token punctuation">,</span> levels<span class="token punctuation">)</span><span class="token punctuation">;</span>

  res<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span>view<span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Fakebook listening to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<h4 class="MuiTypography-root MuiTypography-h4 MuiTypography-gutterBottom css-gtvj52" style="margin-top:24px">Run</h4>
<div class="remark-highlight"><pre class="language-shell"><code class="language-shell"><span class="token function">node</span> index.js
</code></pre></div>
<h4 class="MuiTypography-root MuiTypography-h4 MuiTypography-gutterBottom css-gtvj52" style="margin-top:24px">Test 1</h4>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">We will render friends of user 1. Only 1 level:</p>
<div class="remark-highlight"><pre class="language-text"><code class="language-text">http://localhost:3000/user-with-friends/1</code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">If we check in our console we will find:</p>
<div class="remark-highlight"><pre class="language-text"><code class="language-text">GET /users?ids=1
GET /users?ids=2,3</code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">All good. We requested user 1 and their friends 2 and 3.</p>
<h4 class="MuiTypography-root MuiTypography-h4 MuiTypography-gutterBottom css-gtvj52" style="margin-top:24px">Test 2</h4>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Let&#x27;s try by loading 3 levels:</p>
<div class="remark-highlight"><pre class="language-text"><code class="language-text">http://localhost:3000/user-with-friends/1?levels=3</code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Things are getting interesting here:</p>
<div class="remark-highlight"><pre class="language-text"><code class="language-text">GET /users?ids=1
GET /users?ids=2,3
GET /users?ids=1,3
GET /users?ids=1,2,4
GET /users?ids=2,3
GET /users?ids=1,2,4
GET /users?ids=2,3
GET /users?ids=1,3
GET /users?ids=3,5</code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">We are loading data for users 1,2,3,4,5 but we are doing 9 requests. We are requesting the same users again and again. We could easily improve the situation adding some sort of cache per request.</p>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Cache per request
We are going to add a cache to the system. It will be empty at the start of each request, so we do not need to worry about expirations. The benefits will be:</p>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Do not request the same resource twice to the remote source during the same request.
As side effect, if we try to get the same resource twice during the same request, we will get the same data. So mutations of the resources in between a request will not provide incoherent results.</p>
<h5 class="MuiTypography-root MuiTypography-h5 MuiTypography-gutterBottom css-t1nuxs" style="margin-top:24px">cache.js</h5>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Simple cache implementation:</p>
<div class="remark-highlight"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token parameter">loadManyFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadMany</span><span class="token punctuation">(</span><span class="token parameter">ids</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> notCachedIds <span class="token operator">=</span> ids<span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token operator">!</span>cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>notCachedIds<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">loadManyFn</span><span class="token punctuation">(</span>notCachedIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
      notCachedIds<span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> results<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword control-flow">return</span> ids<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">load</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">loadMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword control-flow">return</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    loadMany<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span> make <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Cache needs a function to retrieve multiple data by id (or in general by a key). It will check the data that is cached and request only the ids that are not found.</p>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Implements the same contract as datasource.</p>
<h5 class="MuiTypography-root MuiTypography-h5 MuiTypography-gutterBottom css-t1nuxs" style="margin-top:24px">server.js</h5>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Let&#x27;s add this line to the server:</p>
<div class="remark-highlight"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./cache&#x27;</span><span class="token punctuation">)</span>
<span class="token maybe-class-name">And</span> replace <span class="token keyword">this</span> <span class="token literal-property property">line</span><span class="token operator">:</span>

<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> resolver<span class="token punctuation">.</span><span class="token method function property-access">getUserWithFriends</span><span class="token punctuation">(</span>datasource<span class="token punctuation">,</span> id<span class="token punctuation">,</span> levels<span class="token punctuation">)</span>
<span class="token keyword">with</span><span class="token operator">:</span>

<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> resolver<span class="token punctuation">.</span><span class="token method function property-access">getUserWithFriends</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token method function property-access">make</span><span class="token punctuation">(</span>datasource<span class="token punctuation">.</span><span class="token property-access">loadMany</span><span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> levels<span class="token punctuation">)</span>
</code></pre></div>
<h4 class="MuiTypography-root MuiTypography-h4 MuiTypography-gutterBottom css-gtvj52" style="margin-top:24px">Run</h4>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Let&#x27;s run again the server and test the previous request:</p>
<div class="remark-highlight"><pre class="language-text"><code class="language-text">http://localhost:3000/user-with-friends/1?levels=3</code></pre></div>
<div class="remark-highlight"><pre class="language-text"><code class="language-text">GET /users?ids=1
GET /users?ids=2,3
GET /users?ids=4
GET /users?ids=4
GET /users?ids=5</code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">We could reduce the number of requests from 9 to 5, which is pretty good. But, what a momentwhat happened here? Why are we requesting id=4 twice?</p>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">If we unnest the request flow based on how nodejs works (and how we implemented our resolver) this is what happened:</p>
<div class="remark-highlight"><pre class="language-text"><code class="language-text">1 - Load user 1 =&amp;gt; GET /users?ids=1
2 - Load friends of 1: [2,3]=&amp;gt; GET /users?ids=2,3
3.1. Load friends of 2: [1,3] =&amp;gt; all cached
4.1. Load friends of 1 : [2,3] =&amp;gt; all cached
4.2. Load friends of 3 : [1,2,4] =&amp;gt; GET /users?ids=4
3.2. Load friends of 3: [1,2,4] =&amp;gt; GET /users?ids=4
4.3. Load friends of 1: [2,3] =&amp;gt; all cached
4.4. Load friends of 2: [1,3] =&amp;gt; all cached
4.5. Load friends of 4: [3,5] =&amp;gt; GET /users?ids=5
On 3.1 we had all friends of user 2 cached. So the code was straight to 4.2, than ran in parallel with 3.2. Both were waiting for the same user (4) and therefore made the same requests twice.</code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">So with our simple cache, we did not reduce the requests to the minimun we wanted.</p>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">For example, if we did:</p>
<div class="remark-highlight"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">all</span><span class="token punctuation">(</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">There would be 2 requests before the cache has data for id=1.</p>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Let&#x27;s fix this and produce the ideal:</p>
<div class="remark-highlight"><pre class="language-text"><code class="language-text">GET /users?ids=1
GET /users?ids=2,3
GET /users?ids=4
GET /users?ids=5</code></pre></div>
<h4 class="MuiTypography-root MuiTypography-h4 MuiTypography-gutterBottom css-gtvj52" style="margin-top:24px">Dataloader</h4>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Using nodejs <code>process.nextTick(...)</code> we can postpone the execution of a given function to the end of the current event loop cycle. It is useful to run a given function after all variables are initialized for example.</p>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">From nodejs documentation:</p>
<div class="remark-highlight"><pre class="language-text"><code class="language-text">By using process.nextTick() we guarantee that apiCall() always runs its callback after the rest of the user&amp;#39;s code and before the event loop is allowed to proceed.</code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Using it we can accumulate all the keys that are being requested during the same cycle (3.2 and 4.2 in the example above) and request them at the end. In the next cycle we would accumulate again the ones that were depending in the previous ones and so on.</p>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">This simple version of dataloader incorporates also code to accomplish the cache:</p>
<div class="remark-highlight"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token parameter">loadManyFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> pending <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> scheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">scheduleSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>pending<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>scheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      scheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span>
        process<span class="token punctuation">.</span><span class="token method function property-access">nextTick</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword control-flow">await</span> <span class="token function">runSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          scheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> pendingCopy <span class="token operator">=</span> pending<span class="token punctuation">.</span><span class="token method function property-access">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> pending<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pending <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>pendingCopy<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">loadManyFn</span><span class="token punctuation">(</span>pendingCopy<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> p<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      pendingCopy<span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> resolve <span class="token punctuation">}</span><span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadMany</span><span class="token punctuation">(</span><span class="token parameter">ids</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> notCachedIds <span class="token operator">=</span> ids<span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token operator">!</span>cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>notCachedIds<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      notCachedIds<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
        cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
          pending<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token punctuation">,</span> resolve <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">scheduleSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword control-flow">return</span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">all</span><span class="token punctuation">(</span>ids<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">load</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">loadMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword control-flow">return</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    loadMany<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span> make <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Ignoring the part of the cache, the important bits are:</p>
<h5 class="MuiTypography-root MuiTypography-h5 MuiTypography-gutterBottom css-t1nuxs" style="margin-top:24px">Accumulating requests</h5>
<div class="remark-highlight"><pre class="language-javascript"><code class="language-javascript">notCachedIds<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
  cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
    pending<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token punctuation">,</span> resolve <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">We will add to the list of pending ids the ones that are not cached. We will keep the id and the resolve method, so we can resolve them afterwards with the right value. We cache the promise itself in the hashmap. This would allow us to cache also rejected promises for example. So we do not request over and over the same rejection. It is not used in this implementation, though.</p>
<h5 class="MuiTypography-root MuiTypography-h5 MuiTypography-gutterBottom css-t1nuxs" style="margin-top:24px">Scheduling the request</h5>
<div class="remark-highlight"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">scheduleSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>pending<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>scheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    scheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span>
      process<span class="token punctuation">.</span><span class="token method function property-access">nextTick</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">await</span> <span class="token function">runSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">That is where the magic happens. This function is short but is the most important one: We schedule/delay the request to the end of all the promises declarations.</p>
<h5 class="MuiTypography-root MuiTypography-h5 MuiTypography-gutterBottom css-t1nuxs" style="margin-top:24px">Executing the search</h5>
<div class="remark-highlight"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> pendingCopy <span class="token operator">=</span> pending<span class="token punctuation">.</span><span class="token method function property-access">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> pending<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pending <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>pendingCopy<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">loadManyFn</span><span class="token punctuation">(</span>pendingCopy<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> p<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pendingCopy<span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> resolve <span class="token punctuation">}</span><span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Clone the ids (so they can be accumulated again after the search completes) and call the loadManyFn so we can resolve the promises we had pending. Remember the requirements of loadMany to return the data in the right order and all the elements ? This is where it is needed. We can reference the results by index and resolve the right pending promises.</p>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Let&#x27;s run it!</p>
<h4 class="MuiTypography-root MuiTypography-h4 MuiTypography-gutterBottom css-gtvj52" style="margin-top:24px">Execution</h4>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Again the same request:</p>
<div class="remark-highlight"><pre class="language-text"><code class="language-text">http://localhost:3000/user-with-friends/1?levels=3</code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">That produces the following output:</p>
<div class="remark-highlight"><pre class="language-text"><code class="language-text">GET /users?ids=1
GET /users?ids=2,3
GET /users?ids=4
GET /users?ids=5</code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Exactly what we wanted.</p>
<h4 class="MuiTypography-root MuiTypography-h4 MuiTypography-gutterBottom css-gtvj52" style="margin-top:24px">Conclusion</h4>
<ul>
<li><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify;margin-bottom:3px">
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Dataloader is a great package that should be in all developers toolbox. Specially the ones implementing Graphql or similar Apis.</p>
</p></li>
<li><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify;margin-bottom:3px">
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">The resolvers in this example could be optimized but sometimes our requests are on different files at different levels that depend on some conditions. With Dataloader we can keep our file structure and code readability without damaging our performance, both on response time to our client and on number of requests spawn within our mesh.</p>
</p></li>
</ul>
<p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph css-wje1bd" style="text-align:justify">Are you using Dataloader? Do you know any tool that accomplishes something similar? Do you now any other packages that in your opinion should be in all nodejs devs toolbox?</p></div></div></div></div></div><footer class="jss6"><style data-emotion="css 1qsxih2">.css-1qsxih2{width:100%;margin-left:auto;box-sizing:border-box;margin-right:auto;display:block;padding-left:16px;padding-right:16px;}@media (min-width:600px){.css-1qsxih2{padding-left:24px;padding-right:24px;}}@media (min-width:1200px){.css-1qsxih2{max-width:1200px;}}</style><div class="MuiContainer-root MuiContainer-maxWidthLg css-1qsxih2"><style data-emotion="css 1is0dyx">.css-1is0dyx{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;text-align:center;color:inherit;}</style><p class="MuiTypography-root MuiTypography-body2 MuiTypography-alignCenter css-1is0dyx">Copyright ¬© <!-- -->tonitienda <!-- -->2024<!-- -->.</p></div></footer></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{"post":{"title":"Understanding data loader","date":"2020-07-19","description":"Create a basic dataloader to understand this great library","thumbnail":{"url":"data-loader.jpg","attribution":{"name":"Lars Kienle","url":"https://unsplash.com/@larskienle?utm_source=unsplash\u0026utm_medium=referral\u0026utm_content=creditCopyText"}},"tags":["javascript"],"filePath":"data-loader.mdx","slug":"data-loader","mdxSource":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    h1: \"h1\",\n    p: \"p\",\n    h2: \"h2\",\n    div: \"div\",\n    pre: \"pre\",\n    code: \"code\",\n    h3: \"h3\",\n    span: \"span\",\n    ul: \"ul\",\n    li: \"li\"\n  }, _provideComponents(), props.components);\n  return _jsxs(_Fragment, {\n    children: [_jsx(_components.h1, {\n      children: \"Understanding the Dataloader\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Dataloader is one of the packages I find more useful and smart from the ones I have in my toolbox.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"I am going to set up a obvious naive example and follow the process to build a simple dataloader to understand its beauty and how useful it is.\"\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"About the project\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"We are going to create a view and api over a social network. Our users relations are:\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-text\",\n        children: _jsx(_components.code, {\n          className: \"language-text\",\n          children: \"User 1 friend of [ 2, 3 ]\\nUser 2 friend of [ 1, 3 ]\\nUser 3 friend of [ 1, 2, 4 ]\\nUser 4 friend of [ 3, 5 ]\\nUser 5 friend of [ 4 ]\"\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"The view can show the relation between users and their friends. We can show N levels of their friendship. We are not goint to look much at it in this post.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Users data can be found here.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"The only dependency will be express.\"\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"Initial Setup\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"datasource.js\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"The datasource allows us to retrieve one or multiple users by id. Contract is not random, it is already based on the real dataloader so there will be minimal changes over the course of the post. Data is defined in a file within the project. Code is pretty simple:\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-javascript\",\n        children: _jsxs(_components.code, {\n          className: \"language-javascript\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" users \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"require\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token string\",\n            children: \"\\\"./users.json\\\"\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\\n\", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function-variable function\",\n            children: \"getUsersFromFile\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"ids\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \"\\n  ids\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"map\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"id\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" users\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"find\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"u\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" u\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"id\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"===\"\n          }), \" id\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\\n\", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function-variable function\",\n            children: \"sleep\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"ms\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"new\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token class-name\",\n            children: \"Promise\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"resolve\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"setTimeout\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"resolve\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" ms\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\\n\", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"async\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"function\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"loadMany\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"ids\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token console class-name\",\n            children: \"console\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"log\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsxs(_components.span, {\n            className: \"token template-string\",\n            children: [_jsx(_components.span, {\n              className: \"token template-punctuation string\",\n              children: \"`\"\n            }), _jsx(_components.span, {\n              className: \"token string\",\n              children: \"GET /users?ids=\"\n            }), _jsxs(_components.span, {\n              className: \"token interpolation\",\n              children: [_jsx(_components.span, {\n                className: \"token interpolation-punctuation punctuation\",\n                children: \"${\"\n              }), \"ids\", _jsx(_components.span, {\n                className: \"token interpolation-punctuation punctuation\",\n                children: \"}\"\n              })]\n            }), _jsx(_components.span, {\n              className: \"token template-punctuation string\",\n              children: \"`\"\n            })]\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\\n  \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"sleep\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token number\",\n            children: \"100\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"return\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"getUsersFromFile\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"ids\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\\n\", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"async\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"function\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"load\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"id\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" results \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"loadMany\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), \"id\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"return\"\n          }), \" results\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), _jsx(_components.span, {\n            className: \"token number\",\n            children: \"0\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\\nmodule\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"exports\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n  load\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \"\\n  loadMany\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\"]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"The only interesting method is loadMany. We will print the requests to the simulated service so we can check the console. There will be a delay to resolve the promise, so we can simulate better and understand why dataloader is so good.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"A very important requirement is that data needs to be returned to the caller in the right order and all elements need to be returned (same length of ids and results arrays). This will be clear when we put in place the dataloader.\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"resolver.js\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Resolver will use the datasource received by parameter to load friendship data about users. It can receive the levels of friends we want to get, so it will use a recursive approach to load friends of friends until all levels are fetched.\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-javascript\",\n        children: _jsxs(_components.code, {\n          className: \"language-javascript\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"async\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"function\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"getFriends\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsxs(_components.span, {\n            className: \"token parameter\",\n            children: [\"datasource\", _jsx(_components.span, {\n              className: \"token punctuation\",\n              children: \",\"\n            }), \" user\", _jsx(_components.span, {\n              className: \"token punctuation\",\n              children: \",\"\n            }), \" levels\"]\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"if\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"levels \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"==\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token number\",\n            children: \"0\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"return\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token literal-property property\",\n            children: \"id\"\n          }), _jsx(_components.span, {\n            className: \"token operator\",\n            children: \":\"\n          }), \" user\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"id\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token literal-property property\",\n            children: \"name\"\n          }), _jsx(_components.span, {\n            className: \"token operator\",\n            children: \":\"\n          }), \" user\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"name\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\\n  \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" friends \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" datasource\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"loadMany\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"user\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"friends\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\\n  \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"return\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token spread operator\",\n            children: \"...\"\n          }), \"user\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token literal-property property\",\n            children: \"friends\"\n          }), _jsx(_components.span, {\n            className: \"token operator\",\n            children: \":\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token known-class-name class-name\",\n            children: \"Promise\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"all\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"\\n      friends\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"map\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"f\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"getFriends\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"datasource\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" f\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" levels \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"-\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token number\",\n            children: \"1\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\\n\", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"async\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"function\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"getUserWithFriends\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsxs(_components.span, {\n            className: \"token parameter\",\n            children: [\"datasource\", _jsx(_components.span, {\n              className: \"token punctuation\",\n              children: \",\"\n            }), \" id\", _jsx(_components.span, {\n              className: \"token punctuation\",\n              children: \",\"\n            }), \" levels \", _jsx(_components.span, {\n              className: \"token operator\",\n              children: \"=\"\n            }), \" \", _jsx(_components.span, {\n              className: \"token number\",\n              children: \"1\"\n            })]\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" user \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" datasource\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"load\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"id\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"return\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"getFriends\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"datasource\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" user\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" levels\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\\nmodule\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"exports\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \" getUserWithFriends \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\"]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"It uses a brute force approach on purpose. The code is simple but far away from being optimal. In one method it looks obvious, but sometimes, when we are building graphql or similar apis, or complex workflows we might be doing exactly this kind of brute force requests.\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"view.js\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Nothing advanced. Just render users friends in a nested way.\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-javascript\",\n        children: _jsxs(_components.code, {\n          className: \"language-javascript\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"function\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"render\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"user\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"return\"\n          }), \" \", _jsxs(_components.span, {\n            className: \"token template-string\",\n            children: [_jsx(_components.span, {\n              className: \"token template-punctuation string\",\n              children: \"`\"\n            }), _jsx(_components.span, {\n              className: \"token string\",\n              children: \"\u003cdiv style=\\\"padding-left: 12px;background-color:#def\\\"\u003e \"\n            }), _jsxs(_components.span, {\n              className: \"token interpolation\",\n              children: [_jsx(_components.span, {\n                className: \"token interpolation-punctuation punctuation\",\n                children: \"${\"\n              }), \"user\", _jsx(_components.span, {\n                className: \"token punctuation\",\n                children: \".\"\n              }), _jsx(_components.span, {\n                className: \"token property-access\",\n                children: \"name\"\n              }), _jsx(_components.span, {\n                className: \"token interpolation-punctuation punctuation\",\n                children: \"}\"\n              })]\n            }), _jsx(_components.span, {\n              className: \"token string\",\n              children: \" \"\n            }), _jsxs(_components.span, {\n              className: \"token interpolation\",\n              children: [_jsx(_components.span, {\n                className: \"token interpolation-punctuation punctuation\",\n                children: \"${\"\n              }), \"\\n    user\", _jsx(_components.span, {\n                className: \"token punctuation\",\n                children: \".\"\n              }), _jsx(_components.span, {\n                className: \"token property-access\",\n                children: \"friends\"\n              }), \" \", _jsx(_components.span, {\n                className: \"token operator\",\n                children: \"?\"\n              }), \" user\", _jsx(_components.span, {\n                className: \"token punctuation\",\n                children: \".\"\n              }), _jsx(_components.span, {\n                className: \"token property-access\",\n                children: \"friends\"\n              }), _jsx(_components.span, {\n                className: \"token punctuation\",\n                children: \".\"\n              }), _jsx(_components.span, {\n                className: \"token method function property-access\",\n                children: \"map\"\n              }), _jsx(_components.span, {\n                className: \"token punctuation\",\n                children: \"(\"\n              }), _jsx(_components.span, {\n                className: \"token punctuation\",\n                children: \"(\"\n              }), _jsx(_components.span, {\n                className: \"token parameter\",\n                children: \"u\"\n              }), _jsx(_components.span, {\n                className: \"token punctuation\",\n                children: \")\"\n              }), \" \", _jsx(_components.span, {\n                className: \"token arrow operator\",\n                children: \"=\u003e\"\n              }), \" \", _jsx(_components.span, {\n                className: \"token function\",\n                children: \"render\"\n              }), _jsx(_components.span, {\n                className: \"token punctuation\",\n                children: \"(\"\n              }), \"u\", _jsx(_components.span, {\n                className: \"token punctuation\",\n                children: \")\"\n              }), _jsx(_components.span, {\n                className: \"token punctuation\",\n                children: \")\"\n              }), _jsx(_components.span, {\n                className: \"token punctuation\",\n                children: \".\"\n              }), _jsx(_components.span, {\n                className: \"token method function property-access\",\n                children: \"join\"\n              }), _jsx(_components.span, {\n                className: \"token punctuation\",\n                children: \"(\"\n              }), _jsx(_components.span, {\n                className: \"token string\",\n                children: \"\\\"\\\"\"\n              }), _jsx(_components.span, {\n                className: \"token punctuation\",\n                children: \")\"\n              }), \" \", _jsx(_components.span, {\n                className: \"token operator\",\n                children: \":\"\n              }), \" \", _jsx(_components.span, {\n                className: \"token string\",\n                children: \"\\\"\\\"\"\n              }), \"\\n  \", _jsx(_components.span, {\n                className: \"token interpolation-punctuation punctuation\",\n                children: \"}\"\n              })]\n            }), _jsx(_components.span, {\n              className: \"token string\",\n              children: \" \u003c/div\u003e\"\n            }), _jsx(_components.span, {\n              className: \"token template-punctuation string\",\n              children: \"`\"\n            })]\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\\nmodule\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"exports\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n  render\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\"]\n        })\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"server.js\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-javascript\",\n        children: _jsxs(_components.code, {\n          className: \"language-javascript\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" express \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"require\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token string\",\n            children: \"\\\"express\\\"\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token constant\",\n            children: \"PORT\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token number\",\n            children: \"3000\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" app \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"express\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\\n\", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" datasource \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"require\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token string\",\n            children: \"\\\"./datasource\\\"\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" resolver \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"require\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token string\",\n            children: \"\\\"./resolver\\\"\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" view \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"require\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token string\",\n            children: \"\\\"./view\\\"\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\\napp\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"get\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsxs(_components.span, {\n            className: \"token template-string\",\n            children: [_jsx(_components.span, {\n              className: \"token template-punctuation string\",\n              children: \"`\"\n            }), _jsx(_components.span, {\n              className: \"token string\",\n              children: \"/user-with-friends/:id\"\n            }), _jsx(_components.span, {\n              className: \"token template-punctuation string\",\n              children: \"`\"\n            })]\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"async\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsxs(_components.span, {\n            className: \"token parameter\",\n            children: [\"req\", _jsx(_components.span, {\n              className: \"token punctuation\",\n              children: \",\"\n            }), \" res\"]\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" id \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" req\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"params\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"id\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" levels \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" req\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"query\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"levels\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"||\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token number\",\n            children: \"1\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\\n  \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" user \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" resolver\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"getUserWithFriends\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"datasource\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" id\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" levels\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\\n  res\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"send\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"view\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"render\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"user\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\\napp\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"listen\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token constant\",\n            children: \"PORT\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token console class-name\",\n            children: \"console\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"log\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsxs(_components.span, {\n            className: \"token template-string\",\n            children: [_jsx(_components.span, {\n              className: \"token template-punctuation string\",\n              children: \"`\"\n            }), _jsx(_components.span, {\n              className: \"token string\",\n              children: \"Fakebook listening to \"\n            }), _jsxs(_components.span, {\n              className: \"token interpolation\",\n              children: [_jsx(_components.span, {\n                className: \"token interpolation-punctuation punctuation\",\n                children: \"${\"\n              }), _jsx(_components.span, {\n                className: \"token constant\",\n                children: \"PORT\"\n              }), _jsx(_components.span, {\n                className: \"token interpolation-punctuation punctuation\",\n                children: \"}\"\n              })]\n            }), _jsx(_components.span, {\n              className: \"token template-punctuation string\",\n              children: \"`\"\n            })]\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\"]\n        })\n      })\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"Run\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-shell\",\n        children: _jsxs(_components.code, {\n          className: \"language-shell\",\n          children: [_jsx(_components.span, {\n            className: \"token function\",\n            children: \"node\"\n          }), \" index.js\\n\"]\n        })\n      })\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"Test 1\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"We will render friends of user 1. Only 1 level:\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-text\",\n        children: _jsx(_components.code, {\n          className: \"language-text\",\n          children: \"http://localhost:3000/user-with-friends/1\"\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"If we check in our console we will find:\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-text\",\n        children: _jsx(_components.code, {\n          className: \"language-text\",\n          children: \"GET /users?ids=1\\nGET /users?ids=2,3\"\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"All good. We requested user 1 and their friends 2 and 3.\"\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"Test 2\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Let's try by loading 3 levels:\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-text\",\n        children: _jsx(_components.code, {\n          className: \"language-text\",\n          children: \"http://localhost:3000/user-with-friends/1?levels=3\"\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Things are getting interesting here:\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-text\",\n        children: _jsx(_components.code, {\n          className: \"language-text\",\n          children: \"GET /users?ids=1\\nGET /users?ids=2,3\\nGET /users?ids=1,3\\nGET /users?ids=1,2,4\\nGET /users?ids=2,3\\nGET /users?ids=1,2,4\\nGET /users?ids=2,3\\nGET /users?ids=1,3\\nGET /users?ids=3,5\"\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"We are loading data for users 1,2,3,4,5 but we are doing 9 requests. We are requesting the same users again and again. We could easily improve the situation adding some sort of cache per request.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Cache per request\\nWe are going to add a cache to the system. It will be empty at the start of each request, so we do not need to worry about expirations. The benefits will be:\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Do not request the same resource twice to the remote source during the same request.\\nAs side effect, if we try to get the same resource twice during the same request, we will get the same data. So mutations of the resources in between a request will not provide incoherent results.\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"cache.js\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Simple cache implementation:\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-javascript\",\n        children: _jsxs(_components.code, {\n          className: \"language-javascript\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"function\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"make\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"loadManyFn\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" cache \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\\n  \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"async\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"function\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"loadMany\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"ids\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" notCachedIds \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" ids\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"filter\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"id\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"!\"\n          }), \"cache\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), \"id\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\\n    \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"if\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"notCachedIds\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"length\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token number\",\n            children: \"0\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n      \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" results \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"loadManyFn\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"notCachedIds\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n      notCachedIds\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"forEach\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsxs(_components.span, {\n            className: \"token parameter\",\n            children: [\"id\", _jsx(_components.span, {\n              className: \"token punctuation\",\n              children: \",\"\n            }), \" idx\"]\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"cache\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), \"id\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" results\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), \"idx\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\\n    \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"return\"\n          }), \" ids\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"map\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"id\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" cache\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), \"id\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\\n  \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"return\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token function-variable function\",\n            children: \"load\"\n          }), _jsx(_components.span, {\n            className: \"token operator\",\n            children: \":\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"async\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"id\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n      \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" results \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"loadMany\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), \"id\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n      \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"return\"\n          }), \" results\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), _jsx(_components.span, {\n            className: \"token number\",\n            children: \"0\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \"\\n    loadMany\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\\nmodule\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"exports\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \" make \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\"]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Cache needs a function to retrieve multiple data by id (or in general by a key). It will check the data that is cached and request only the ids that are not found.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Implements the same contract as datasource.\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"server.js\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Let's add this line to the server:\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-javascript\",\n        children: _jsxs(_components.code, {\n          className: \"language-javascript\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" cache \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"require\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token string\",\n            children: \"'./cache'\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token maybe-class-name\",\n            children: \"And\"\n          }), \" replace \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"this\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token literal-property property\",\n            children: \"line\"\n          }), _jsx(_components.span, {\n            className: \"token operator\",\n            children: \":\"\n          }), \"\\n\\n\", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" user \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" resolver\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"getUserWithFriends\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"datasource\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" id\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" levels\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"with\"\n          }), _jsx(_components.span, {\n            className: \"token operator\",\n            children: \":\"\n          }), \"\\n\\n\", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" user \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" resolver\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"getUserWithFriends\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"cache\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"make\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"datasource\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"loadMany\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" id\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" levels\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \"\\n\"]\n        })\n      })\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"Run\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Let's run again the server and test the previous request:\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-text\",\n        children: _jsx(_components.code, {\n          className: \"language-text\",\n          children: \"http://localhost:3000/user-with-friends/1?levels=3\"\n        })\n      })\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-text\",\n        children: _jsx(_components.code, {\n          className: \"language-text\",\n          children: \"GET /users?ids=1\\nGET /users?ids=2,3\\nGET /users?ids=4\\nGET /users?ids=4\\nGET /users?ids=5\"\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"We could reduce the number of requests from 9 to 5, which is pretty good. But, what a momentwhat happened here? Why are we requesting id=4 twice?\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"If we unnest the request flow based on how nodejs works (and how we implemented our resolver) this is what happened:\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-text\",\n        children: _jsx(_components.code, {\n          className: \"language-text\",\n          children: \"1 - Load user 1 =\u0026gt; GET /users?ids=1\\n2 - Load friends of 1: [2,3]=\u0026gt; GET /users?ids=2,3\\n3.1. Load friends of 2: [1,3] =\u0026gt; all cached\\n4.1. Load friends of 1 : [2,3] =\u0026gt; all cached\\n4.2. Load friends of 3 : [1,2,4] =\u0026gt; GET /users?ids=4\\n3.2. Load friends of 3: [1,2,4] =\u0026gt; GET /users?ids=4\\n4.3. Load friends of 1: [2,3] =\u0026gt; all cached\\n4.4. Load friends of 2: [1,3] =\u0026gt; all cached\\n4.5. Load friends of 4: [3,5] =\u0026gt; GET /users?ids=5\\nOn 3.1 we had all friends of user 2 cached. So the code was straight to 4.2, than ran in parallel with 3.2. Both were waiting for the same user (4) and therefore made the same requests twice.\"\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"So with our simple cache, we did not reduce the requests to the minimun we wanted.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"For example, if we did:\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-javascript\",\n        children: _jsxs(_components.code, {\n          className: \"language-javascript\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" users \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token known-class-name class-name\",\n            children: \"Promise\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"all\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token function\",\n            children: \"load\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token number\",\n            children: \"1\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"load\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token number\",\n            children: \"1\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\"]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"There would be 2 requests before the cache has data for id=1.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Let's fix this and produce the ideal:\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-text\",\n        children: _jsx(_components.code, {\n          className: \"language-text\",\n          children: \"GET /users?ids=1\\nGET /users?ids=2,3\\nGET /users?ids=4\\nGET /users?ids=5\"\n        })\n      })\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"Dataloader\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Using nodejs \", _jsx(_components.code, {\n        children: \"process.nextTick(...)\"\n      }), \" we can postpone the execution of a given function to the end of the current event loop cycle. It is useful to run a given function after all variables are initialized for example.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"From nodejs documentation:\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-text\",\n        children: _jsx(_components.code, {\n          className: \"language-text\",\n          children: \"By using process.nextTick() we guarantee that apiCall() always runs its callback after the rest of the user\u0026#39;s code and before the event loop is allowed to proceed.\"\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Using it we can accumulate all the keys that are being requested during the same cycle (3.2 and 4.2 in the example above) and request them at the end. In the next cycle we would accumulate again the ones that were depending in the previous ones and so on.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"This simple version of dataloader incorporates also code to accomplish the cache:\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-javascript\",\n        children: _jsxs(_components.code, {\n          className: \"language-javascript\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"function\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"make\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"loadManyFn\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" cache \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"let\"\n          }), \" pending \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"let\"\n          }), \" scheduled \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token boolean\",\n            children: \"false\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"function\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"scheduleSearch\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"if\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"pending\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"length\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token number\",\n            children: \"0\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"\u0026\u0026\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"!\"\n          }), \"scheduled\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n      scheduled \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token boolean\",\n            children: \"true\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n      \", _jsx(_components.span, {\n            className: \"token known-class-name class-name\",\n            children: \"Promise\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"resolve\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"then\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \"\\n        process\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"nextTick\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"async\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n          \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"runSearch\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n          scheduled \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token boolean\",\n            children: \"false\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n        \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \"\\n      \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\\n  \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"async\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"function\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"runSearch\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" pendingCopy \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" pending\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"splice\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token number\",\n            children: \"0\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" pending\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"length\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n    pending \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\\n    \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"if\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"pendingCopy\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"length\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token number\",\n            children: \"0\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n      \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" results \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"loadManyFn\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"pendingCopy\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"map\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"p\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" p\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"id\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n      pendingCopy\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"forEach\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsxs(_components.span, {\n            className: \"token parameter\",\n            children: [_jsx(_components.span, {\n              className: \"token punctuation\",\n              children: \"{\"\n            }), \" resolve \", _jsx(_components.span, {\n              className: \"token punctuation\",\n              children: \"}\"\n            }), _jsx(_components.span, {\n              className: \"token punctuation\",\n              children: \",\"\n            }), \" idx\"]\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"resolve\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"results\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), \"idx\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\\n  \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"async\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"function\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"loadMany\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"ids\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" notCachedIds \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" ids\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"filter\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"id\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"!\"\n          }), \"cache\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), \"id\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\\n    \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"if\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"notCachedIds\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"length\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token number\",\n            children: \"0\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n      notCachedIds\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"map\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"id\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n        cache\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), \"id\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"new\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token class-name\",\n            children: \"Promise\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"resolve\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n          pending\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"push\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \" id\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" resolve \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n        \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n      \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\\n      \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"scheduleSearch\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\\n    \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"return\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token known-class-name class-name\",\n            children: \"Promise\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"all\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"ids\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"map\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"id\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" cache\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), \"id\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\\n  \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"return\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token function-variable function\",\n            children: \"load\"\n          }), _jsx(_components.span, {\n            className: \"token operator\",\n            children: \":\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"async\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"id\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n      \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" results \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"loadMany\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), \"id\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n      \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"return\"\n          }), \" results\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), _jsx(_components.span, {\n            className: \"token number\",\n            children: \"0\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \"\\n    loadMany\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\\nmodule\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"exports\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \" make \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\"]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Ignoring the part of the cache, the important bits are:\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Accumulating requests\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-javascript\",\n        children: _jsxs(_components.code, {\n          className: \"language-javascript\",\n          children: [\"notCachedIds\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"map\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"id\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n  cache\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), \"id\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"new\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token class-name\",\n            children: \"Promise\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"resolve\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n    pending\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"push\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \" id\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" resolve \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\"]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"We will add to the list of pending ids the ones that are not cached. We will keep the id and the resolve method, so we can resolve them afterwards with the right value. We cache the promise itself in the hashmap. This would allow us to cache also rejected promises for example. So we do not request over and over the same rejection. It is not used in this implementation, though.\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Scheduling the request\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-javascript\",\n        children: _jsxs(_components.code, {\n          className: \"language-javascript\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"function\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"scheduleSearch\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"if\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"pending\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"length\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token number\",\n            children: \"0\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"\u0026\u0026\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"!\"\n          }), \"scheduled\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n    scheduled \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token boolean\",\n            children: \"true\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token known-class-name class-name\",\n            children: \"Promise\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"resolve\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"then\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \"\\n      process\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"nextTick\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"async\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n        \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"runSearch\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n        scheduled \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token boolean\",\n            children: \"false\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n      \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\"]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"That is where the magic happens. This function is short but is the most important one: We schedule/delay the request to the end of all the promises declarations.\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Executing the search\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-javascript\",\n        children: _jsxs(_components.code, {\n          className: \"language-javascript\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"async\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"function\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"runSearch\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" pendingCopy \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" pending\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"splice\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token number\",\n            children: \"0\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \" pending\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"length\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n  pending \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n\\n  \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"if\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"pendingCopy\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"length\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token number\",\n            children: \"0\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" results \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"loadManyFn\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"pendingCopy\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"map\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token parameter\",\n            children: \"p\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" p\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"id\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n    pendingCopy\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"forEach\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsxs(_components.span, {\n            className: \"token parameter\",\n            children: [_jsx(_components.span, {\n              className: \"token punctuation\",\n              children: \"{\"\n            }), \" resolve \", _jsx(_components.span, {\n              className: \"token punctuation\",\n              children: \"}\"\n            }), _jsx(_components.span, {\n              className: \"token punctuation\",\n              children: \",\"\n            }), \" idx\"]\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=\u003e\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"resolve\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"results\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), \"idx\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\"]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Clone the ids (so they can be accumulated again after the search completes) and call the loadManyFn so we can resolve the promises we had pending. Remember the requirements of loadMany to return the data in the right order and all the elements ? This is where it is needed. We can reference the results by index and resolve the right pending promises.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Let's run it!\"\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"Execution\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Again the same request:\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-text\",\n        children: _jsx(_components.code, {\n          className: \"language-text\",\n          children: \"http://localhost:3000/user-with-friends/1?levels=3\"\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"That produces the following output:\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-text\",\n        children: _jsx(_components.code, {\n          className: \"language-text\",\n          children: \"GET /users?ids=1\\nGET /users?ids=2,3\\nGET /users?ids=4\\nGET /users?ids=5\"\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Exactly what we wanted.\"\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"Conclusion\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsx(_components.p, {\n          children: \"Dataloader is a great package that should be in all developers toolbox. Specially the ones implementing Graphql or similar Apis.\"\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsx(_components.p, {\n          children: \"The resolvers in this example could be optimized but sometimes our requests are on different files at different levels that depend on some conditions. With Dataloader we can keep our file structure and code readability without damaging our performance, both on response time to our client and on number of requests spawn within our mesh.\"\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Are you using Dataloader? Do you know any tool that accomplishes something similar? Do you now any other packages that in your opinion should be in all nodejs devs toolbox?\"\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}},"markdown":"# Understanding the Dataloader\n\nDataloader is one of the packages I find more useful and smart from the ones I have in my toolbox.\n\nI am going to set up a obvious naive example and follow the process to build a simple dataloader to understand its beauty and how useful it is.\n\n## About the project\n\nWe are going to create a view and api over a social network. Our users relations are:\n\n```text\nUser 1 friend of [ 2, 3 ]\nUser 2 friend of [ 1, 3 ]\nUser 3 friend of [ 1, 2, 4 ]\nUser 4 friend of [ 3, 5 ]\nUser 5 friend of [ 4 ]\n```\n\nThe view can show the relation between users and their friends. We can show N levels of their friendship. We are not goint to look much at it in this post.\n\nUsers data can be found here.\n\nThe only dependency will be express.\n\n## Initial Setup\n\n### datasource.js\n\nThe datasource allows us to retrieve one or multiple users by id. Contract is not random, it is already based on the real dataloader so there will be minimal changes over the course of the post. Data is defined in a file within the project. Code is pretty simple:\n\n```javascript\nconst users = require(\"./users.json\");\n\nconst getUsersFromFile = (ids) =\u003e\n  ids.map((id) =\u003e users.find((u) =\u003e u.id === id));\n\nconst sleep = (ms) =\u003e new Promise((resolve) =\u003e setTimeout(resolve, ms));\n\nasync function loadMany(ids) {\n  console.log(`GET /users?ids=${ids}`);\n\n  await sleep(100);\n  return getUsersFromFile(ids);\n}\n\nasync function load(id) {\n  const results = await loadMany([id]);\n  return results[0];\n}\n\nmodule.exports = {\n  load,\n  loadMany,\n};\n```\n\nThe only interesting method is loadMany. We will print the requests to the simulated service so we can check the console. There will be a delay to resolve the promise, so we can simulate better and understand why dataloader is so good.\n\nA very important requirement is that data needs to be returned to the caller in the right order and all elements need to be returned (same length of ids and results arrays). This will be clear when we put in place the dataloader.\n\n### resolver.js\n\nResolver will use the datasource received by parameter to load friendship data about users. It can receive the levels of friends we want to get, so it will use a recursive approach to load friends of friends until all levels are fetched.\n\n```javascript\nasync function getFriends(datasource, user, levels) {\n  if (levels == 0) {\n    return { id: user.id, name: user.name };\n  }\n\n  const friends = await datasource.loadMany(user.friends);\n\n  return {\n    ...user,\n    friends: await Promise.all(\n      friends.map((f) =\u003e getFriends(datasource, f, levels - 1))\n    ),\n  };\n}\n\nasync function getUserWithFriends(datasource, id, levels = 1) {\n  const user = await datasource.load(id);\n  return getFriends(datasource, user, levels);\n}\n\nmodule.exports = { getUserWithFriends };\n```\n\nIt uses a brute force approach on purpose. The code is simple but far away from being optimal. In one method it looks obvious, but sometimes, when we are building graphql or similar apis, or complex workflows we might be doing exactly this kind of brute force requests.\n\n### view.js\n\nNothing advanced. Just render users friends in a nested way.\n\n```javascript\nfunction render(user) {\n  return `\u003cdiv style=\"padding-left: 12px;background-color:#def\"\u003e ${user.name} ${\n    user.friends ? user.friends.map((u) =\u003e render(u)).join(\"\") : \"\"\n  } \u003c/div\u003e`;\n}\n\nmodule.exports = {\n  render,\n};\n```\n\n### server.js\n\n```javascript\nconst express = require(\"express\");\nconst PORT = 3000;\nconst app = express();\n\nconst datasource = require(\"./datasource\");\nconst resolver = require(\"./resolver\");\nconst view = require(\"./view\");\n\napp.get(`/user-with-friends/:id`, async (req, res) =\u003e {\n  const id = req.params.id;\n  const levels = req.query.levels || 1;\n\n  const user = await resolver.getUserWithFriends(datasource, id, levels);\n\n  res.send(view.render(user));\n});\n\napp.listen(PORT, () =\u003e console.log(`Fakebook listening to ${PORT}`));\n```\n\n## Run\n\n```shell\nnode index.js\n```\n\n## Test 1\n\nWe will render friends of user 1. Only 1 level:\n\n```text\nhttp://localhost:3000/user-with-friends/1\n```\n\nIf we check in our console we will find:\n\n```text\nGET /users?ids=1\nGET /users?ids=2,3\n```\n\nAll good. We requested user 1 and their friends 2 and 3.\n\n## Test 2\n\nLet's try by loading 3 levels:\n\n```text\nhttp://localhost:3000/user-with-friends/1?levels=3\n```\n\nThings are getting interesting here:\n\n```text\nGET /users?ids=1\nGET /users?ids=2,3\nGET /users?ids=1,3\nGET /users?ids=1,2,4\nGET /users?ids=2,3\nGET /users?ids=1,2,4\nGET /users?ids=2,3\nGET /users?ids=1,3\nGET /users?ids=3,5\n```\n\nWe are loading data for users 1,2,3,4,5 but we are doing 9 requests. We are requesting the same users again and again. We could easily improve the situation adding some sort of cache per request.\n\nCache per request\nWe are going to add a cache to the system. It will be empty at the start of each request, so we do not need to worry about expirations. The benefits will be:\n\nDo not request the same resource twice to the remote source during the same request.\nAs side effect, if we try to get the same resource twice during the same request, we will get the same data. So mutations of the resources in between a request will not provide incoherent results.\n\n### cache.js\n\nSimple cache implementation:\n\n```javascript\nfunction make(loadManyFn) {\n  const cache = {};\n\n  async function loadMany(ids) {\n    const notCachedIds = ids.filter((id) =\u003e !cache[id]);\n\n    if (notCachedIds.length \u003e 0) {\n      const results = await loadManyFn(notCachedIds);\n      notCachedIds.forEach((id, idx) =\u003e (cache[id] = results[idx]));\n    }\n\n    return ids.map((id) =\u003e cache[id]);\n  }\n\n  return {\n    load: async (id) =\u003e {\n      const results = await loadMany([id]);\n      return results[0];\n    },\n    loadMany,\n  };\n}\n\nmodule.exports = { make };\n```\n\nCache needs a function to retrieve multiple data by id (or in general by a key). It will check the data that is cached and request only the ids that are not found.\n\nImplements the same contract as datasource.\n\n### server.js\n\nLet's add this line to the server:\n\n```javascript\nconst cache = require('./cache')\nAnd replace this line:\n\nconst user = await resolver.getUserWithFriends(datasource, id, levels)\nwith:\n\nconst user = await resolver.getUserWithFriends(cache.make(datasource.loadMany), id, levels)\n```\n\n## Run\n\nLet's run again the server and test the previous request:\n\n```text\nhttp://localhost:3000/user-with-friends/1?levels=3\n```\n\n```text\nGET /users?ids=1\nGET /users?ids=2,3\nGET /users?ids=4\nGET /users?ids=4\nGET /users?ids=5\n```\n\nWe could reduce the number of requests from 9 to 5, which is pretty good. But, what a momentwhat happened here? Why are we requesting id=4 twice?\n\nIf we unnest the request flow based on how nodejs works (and how we implemented our resolver) this is what happened:\n\n```text\n1 - Load user 1 =\u003e GET /users?ids=1\n2 - Load friends of 1: [2,3]=\u003e GET /users?ids=2,3\n3.1. Load friends of 2: [1,3] =\u003e all cached\n4.1. Load friends of 1 : [2,3] =\u003e all cached\n4.2. Load friends of 3 : [1,2,4] =\u003e GET /users?ids=4\n3.2. Load friends of 3: [1,2,4] =\u003e GET /users?ids=4\n4.3. Load friends of 1: [2,3] =\u003e all cached\n4.4. Load friends of 2: [1,3] =\u003e all cached\n4.5. Load friends of 4: [3,5] =\u003e GET /users?ids=5\nOn 3.1 we had all friends of user 2 cached. So the code was straight to 4.2, than ran in parallel with 3.2. Both were waiting for the same user (4) and therefore made the same requests twice.\n```\n\nSo with our simple cache, we did not reduce the requests to the minimun we wanted.\n\nFor example, if we did:\n\n```javascript\nconst users = await Promise.all(load(1), load(1));\n```\n\nThere would be 2 requests before the cache has data for id=1.\n\nLet's fix this and produce the ideal:\n\n```text\nGET /users?ids=1\nGET /users?ids=2,3\nGET /users?ids=4\nGET /users?ids=5\n```\n\n## Dataloader\n\nUsing nodejs `process.nextTick(...)` we can postpone the execution of a given function to the end of the current event loop cycle. It is useful to run a given function after all variables are initialized for example.\n\nFrom nodejs documentation:\n\n```text\nBy using process.nextTick() we guarantee that apiCall() always runs its callback after the rest of the user's code and before the event loop is allowed to proceed.\n```\n\nUsing it we can accumulate all the keys that are being requested during the same cycle (3.2 and 4.2 in the example above) and request them at the end. In the next cycle we would accumulate again the ones that were depending in the previous ones and so on.\n\nThis simple version of dataloader incorporates also code to accomplish the cache:\n\n```javascript\nfunction make(loadManyFn) {\n  const cache = {};\n  let pending = [];\n  let scheduled = false;\n  function scheduleSearch() {\n    if (pending.length \u003e 0 \u0026\u0026 !scheduled) {\n      scheduled = true;\n      Promise.resolve().then(() =\u003e\n        process.nextTick(async () =\u003e {\n          await runSearch();\n          scheduled = false;\n        })\n      );\n    }\n  }\n\n  async function runSearch() {\n    const pendingCopy = pending.splice(0, pending.length);\n    pending = [];\n\n    if (pendingCopy.length \u003e 0) {\n      const results = await loadManyFn(pendingCopy.map((p) =\u003e p.id));\n      pendingCopy.forEach(({ resolve }, idx) =\u003e resolve(results[idx]));\n    }\n  }\n\n  async function loadMany(ids) {\n    const notCachedIds = ids.filter((id) =\u003e !cache[id]);\n\n    if (notCachedIds.length \u003e 0) {\n      notCachedIds.map((id) =\u003e {\n        cache[id] = new Promise((resolve) =\u003e {\n          pending.push({ id, resolve });\n        });\n      });\n\n      scheduleSearch();\n    }\n\n    return Promise.all(ids.map((id) =\u003e cache[id]));\n  }\n\n  return {\n    load: async (id) =\u003e {\n      const results = await loadMany([id]);\n      return results[0];\n    },\n    loadMany,\n  };\n}\n\nmodule.exports = { make };\n```\n\nIgnoring the part of the cache, the important bits are:\n\n### Accumulating requests\n\n```javascript\nnotCachedIds.map((id) =\u003e {\n  cache[id] = new Promise((resolve) =\u003e {\n    pending.push({ id, resolve });\n  });\n});\n```\n\nWe will add to the list of pending ids the ones that are not cached. We will keep the id and the resolve method, so we can resolve them afterwards with the right value. We cache the promise itself in the hashmap. This would allow us to cache also rejected promises for example. So we do not request over and over the same rejection. It is not used in this implementation, though.\n\n### Scheduling the request\n\n```javascript\nfunction scheduleSearch() {\n  if (pending.length \u003e 0 \u0026\u0026 !scheduled) {\n    scheduled = true;\n    Promise.resolve().then(() =\u003e\n      process.nextTick(async () =\u003e {\n        await runSearch();\n        scheduled = false;\n      })\n    );\n  }\n}\n```\n\nThat is where the magic happens. This function is short but is the most important one: We schedule/delay the request to the end of all the promises declarations.\n\n### Executing the search\n\n```javascript\nasync function runSearch() {\n  const pendingCopy = pending.splice(0, pending.length);\n  pending = [];\n\n  if (pendingCopy.length \u003e 0) {\n    const results = await loadManyFn(pendingCopy.map((p) =\u003e p.id));\n    pendingCopy.forEach(({ resolve }, idx) =\u003e resolve(results[idx]));\n  }\n}\n```\n\nClone the ids (so they can be accumulated again after the search completes) and call the loadManyFn so we can resolve the promises we had pending. Remember the requirements of loadMany to return the data in the right order and all the elements ? This is where it is needed. We can reference the results by index and resolve the right pending promises.\n\nLet's run it!\n\n## Execution\n\nAgain the same request:\n\n```text\nhttp://localhost:3000/user-with-friends/1?levels=3\n```\n\nThat produces the following output:\n\n```text\nGET /users?ids=1\nGET /users?ids=2,3\nGET /users?ids=4\nGET /users?ids=5\n```\n\nExactly what we wanted.\n\n## Conclusion\n\n- Dataloader is a great package that should be in all developers toolbox. Specially the ones implementing Graphql or similar Apis.\n\n- The resolvers in this example could be optimized but sometimes our requests are on different files at different levels that depend on some conditions. With Dataloader we can keep our file structure and code readability without damaging our performance, both on response time to our client and on number of requests spawn within our mesh.\n\nAre you using Dataloader? Do you know any tool that accomplishes something similar? Do you now any other packages that in your opinion should be in all nodejs devs toolbox?\n"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"data-loader"},"buildId":"otESvGl4OI2fDtGK8bZWs","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>