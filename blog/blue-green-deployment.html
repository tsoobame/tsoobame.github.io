

<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="/static/styles.css" rel="stylesheet" />
    <title></title>
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id="
    ></script>
    <script>
      window.dataLayer = window.dataLayer || []
      function gtag() {
        dataLayer.push(arguments)
      }
      gtag("js", new Date())
      gtag("config", "", { page_path: window.location.pathname })
    </script>
  </head>
  <body>
    <main>
      <header>
        <nav>
          
          <h2 style="width: 12rem; text-align: left">
            
            <a color="inherit" href="/blog"></a>
          </h2>
          <div class="navbar-links">
            
            <button
              tabindex="0"
              type="button"
              class="active"
              
            >
              <a href="/blog" color="inherit">blog</a>
            </button>
            
            <button
              tabindex="0"
              type="button"
              
            >
              <a href="/projects" color="inherit">projects</a>
            </button>
            
          </div>
        </nav>
      </header>

      <div class="container mx-auto px-4 pt-8"><div class="mb-8">
  
  <div class="mb-4 text-end">
    <img
      src="https://res.cloudinary.com/ddkok43g3/image/upload/w_auto,h_400,c_fill,g_auto,q_auto,f_auto/blue-green-deployment.jpg"
      alt=""
      class="w-full h-[400px] object-cover rounded"
    />

    
    <div class="mt-2">
      
        <a
          href="tags/devops.html"
          class="inline-block bg-[rgb(0,119,151)] text-white text-xs font-medium px-2 py-1 rounded me-1"
        >
          devops
        </a>
      
        <a
          href="tags/deployment.html"
          class="inline-block bg-[rgb(0,119,151)] text-white text-xs font-medium px-2 py-1 rounded me-1"
        >
          deployment
        </a>
      
        <a
          href="tags/multipass.html"
          class="inline-block bg-[rgb(0,119,151)] text-white text-xs font-medium px-2 py-1 rounded me-1"
        >
          multipass
        </a>
      
        <a
          href="tags/vm.html"
          class="inline-block bg-[rgb(0,119,151)] text-white text-xs font-medium px-2 py-1 rounded me-1"
        >
          vm
        </a>
      
    </div>

    
    <small class="text-gray-500 text-sm mt-2 inline-block">
      Photo by
      <a
        href="https://unsplash.com/@brian_yuri?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash"
        class="underline hover:text-[rgb(0,119,151)]"
        target="_blank"
        rel="noopener noreferrer"
      >
        "Brian Yurasits"
      </a>
    </small>
  </div>

  
  <article class="post-content">
    <h1 id="blue-green-deployment">Blue green deployment</h1>
<h2 id="motivation">Motivation</h2>
<p>I follow <a href="https://x.com/levelsio?lang=en">Pieter Levels</a> and he uses (and inspires others to use) a simple tech stack and process. And codes directly on the production VPS. That saves him tons of money (no cloud, k8s, etc) and makes fixing bugs in production very simple.</p>
<p>At the time of this post <a href="https://ramen.tools/@levelsio">the tools he uses are</a>:</p>
<ul>
<li>PHP and JS (with JQuery) as programming language</li>
<li>A VPS in vendors like Linode or Hetzner</li>
<li>SQLite</li>
<li>Cloudflare for cdn and content caching</li>
</ul>
<p>That works well for an indie dev and with interpreted languages.<br />
For compiled languages, thought, things get a bit trickier:</p>
<ul>
<li>You need to compile the app
<ul>
<li>You do not want to use resources of the production VPS to do so</li>
</ul>
</li>
<li>In order to deploy a new version you need to stop the previous one</li>
</ul>
<p>That got me thinking about how I could (hypothetically) use this lean approach for Go.<br />
For that reason I created this post. It tries to adapt <a href="https://x.com/levelsio?lang=en">levelsio</a>'s way of working to a compiled server like Go.</p>
<p>With this post I am not inviting people to use this approach in production systems. We need to consider all the tradeoffs of going fully hacker, fully corporate, or something in between.<br />
I am not responsible for any issues caused in production systems due to following this post.</p>
<h2 id="what-are-we-going-to-do">What are we going to do</h2>
<p>In this post we will create a simple blue-green deployment for our Go app.</p>
<p><strong>Block 1: Configure the VM with nginx and the simple golang server</strong></p>
<ul>
<li>Create a simple Go server with a health endpoint</li>
<li>Create a local VM with multipass</li>
<li>Install nginx in the VM</li>
<li>Deploy the Go server to the VM</li>
<li>Configure nginx to proxy requests to our application</li>
</ul>
<p><strong>Block 2: Configure blue green deployment</strong></p>
<ul>
<li>Add status endpoint and color attribute to the server</li>
<li>Implement blue-green deployment scripts</li>
<li>Test the complete blue-green deployment process</li>
</ul>
<p>I assume knowledge of Go and HTTP servers and basic knowledge about nginx (at least that it exists and what it does).</p>
<p>Let's start!</p>
<h2 id="block-1-configure-the-vm-with-nginx-and-the-simple-golang-server">Block 1: Configure the VM with nginx and the simple golang server</h2>
<svg width="800" height="300" xmlns="http://www.w3.org/2000/svg">
        <!-- Background -->
        <rect width="800" height="300" fill="#ffffff"/>
        
        
<g transform="translate(50.000000,25.000000)">
    <g class="ns" filter="url(#softShadow)">
            <rect x="0" y="0" width="250.000000" height="200.000000" rx="3.906250" fill="#e6f3ff" stroke="#666"/>
            <rect x="0" y="0" width="250.000000" height="20.952380" rx="3.906250" ry="3.906250" fill="#e6f3ff" stroke="#666"/>
            <rect x="39.062500" y="4.761900" width="187.500000" height="11.428560" rx="2.343750" fill="#fff" stroke="#666" opacity="0.85"/>
            <rect x="4.687500" y="26.666660" width="240.625000" height="167.619040" rx="2.343750" fill="#ffffff" stroke="#666" opacity="0.9"/>
    </g>
    <text x="132.812500" y="10.476180" text-anchor="middle" dominant-baseline="middle"
            font-family="-apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"
            font-size="10.000000" fill="#666">http://multipass/home</text>
    <text x="125.000000" y="110.476180" text-anchor="middle" dominant-baseline="middle"
            font-family="-apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"
            font-size="25" fill="#666">Home Page</text>
    
<g transform="translate(5.468750,6.666660)">
        <circle r="2.343750" cx="0" cy="3.117188" fill="#ff5f57"/>
        <circle r="2.343750" cx="7.031250" cy="3.117188" fill="#febc2e"/>
        <circle r="2.343750" cx="14.062500" cy="3.117188" fill="#28c840"/>
</g>


</g>

<g transform="translate(350.000000,25.000000)">
        <g class="ns" filter="url(#softShadow)">
                <rect x="0" y="0" width="400.000000" height="200.000000" rx="6.250000" fill="#666" stroke="#eee"/>
                <rect x="0" y="0" width="400.000000" height="20.952380" rx="6.250000" ry="6.250000" fill="#666" stroke="#eee"/>
                <rect x="7.500000" y="26.666660" width="385.000000" height="167.619040" rx="3.750000" fill="#f0f8ff" stroke="#eee" opacity="0.9"/>
        </g>    
        
        
        <text x="62.500000" 
                y="10.761900" 
                text-anchor="start" 
                dominant-baseline="middle"
                font-family="-apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"
                font-size="14.000000000000002" 
                fill="#eee">ubuntu@multipass</text>
        
<g transform="translate(8.750000,6.666660)">
        <circle r="3.750000" cx="0" cy="4.987500" fill="#ff5f57"/>
        <circle r="3.750000" cx="11.250000" cy="4.987500" fill="#febc2e"/>
        <circle r="3.750000" cx="22.500000" cy="4.987500" fill="#28c840"/>
</g>


        <g transform="translate(7.500000,26.666660)" class="vm-content">
<g transform="translate(20.000000,53.333340)">
    
    <rect x="0" y="0" width="150.000000" height="40.000000"
          rx="4.000000" ry="4.000000"
          fill="#f0f8ff" stroke="#333" stroke-width="2"/>

    
    
    
    <g transform="translate(6.000000,6.000000)">
        
        
        <rect x="0" y="0" width="28.000000" height="28.000000" fill="#009639"/>
        <text x="14.000000" y="19.600000"
              fill="#ffffff" font-family="Arial" font-size="16.800000"
              text-anchor="middle">N</text>
        
    </g>

    
    <text x="46.000000"
          y="24.000000"
          fill="#333"
          font-family="Arial"
          font-size="16.000000"
          >nginx</text>

    
    <text x="144.000000"
          y="24.000000"
          fill="#333"
          font-family="Arial"
          font-size="14.000000"
          text-anchor="end">:80</text>
</g>

<g transform="translate(200.000000,53.333340)">
    
    <rect x="0" y="0" width="150.000000" height="40.000000"
          rx="4.000000" ry="4.000000"
          fill="#f0f8ff" stroke="#333" stroke-width="2"/>

    
    
    
    <g transform="translate(6.000000,6.000000)">
        
        
        <rect x="0" y="0" width="28.000000" height="28.000000" fill="#00ADD8"/>
        <text x="14.000000" y="19.600000"
              fill="#ffffff" font-family="Arial" font-size="16.800000"
              text-anchor="middle">Go</text>
        
    </g>

    
    <text x="46.000000"
          y="24.000000"
          fill="#333"
          font-family="Arial"
          font-size="16.000000"
          >app</text>

    
    <text x="144.000000"
          y="24.000000"
          fill="#333"
          font-family="Arial"
          font-size="14.000000"
          text-anchor="end">:8081</text>
</g>
</g>
</g>

<g class="connector">
    <defs>
        <marker id="arrowhead-17" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#1f2937"/>
        </marker>
    </defs>
    <polyline
        points="300.00,125.00 377.50,125.00" stroke="#1f2937" stroke-width="2.00" fill="none" stroke-linecap="round" stroke-linejoin="round" marker-end="url(#arrowhead-17)"
    />
</g>

<g class="connector">
    <defs>
        <marker id="arrowhead-18" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#1f2937"/>
        </marker>
    </defs>
    <polyline
        points="527.50,125.00 557.50,125.00" stroke="#1f2937" stroke-width="2.00" fill="none" stroke-linecap="round" stroke-linejoin="round" marker-end="url(#arrowhead-18)"
    />
</g>

</svg><h3 id="creating-our-simple-go-server">Creating our simple Go server</h3>
<p>Let's first initialize our Go project with <code>go mod init bluegreen-demo</code></p>
<p>The official way to initialize a Go module is using a git repo, but for our use case we are using this simple name.<br />
Let's create our server:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>cmd/
</span></span><span style="display:flex;"><span>    main.go &lt;-- this file
</span></span></code></pre><p>We will create a http server with a healthcheck that will return a json and the status 200.<br />
We can pass the port it has to listen to via cli args.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#d14">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d14">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d14">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">writeJsonResponse</span>(w http.ResponseWriter, data <span style="color:#000;font-weight:bold">map</span>[<span style="color:#458;font-weight:bold">string</span>]<span style="color:#458;font-weight:bold">string</span>) {
</span></span><span style="display:flex;"><span>	w.<span style="color:#900;font-weight:bold">Header</span>().<span style="color:#900;font-weight:bold">Set</span>(<span style="color:#d14">&#34;Content-Type&#34;</span>, <span style="color:#d14">&#34;application/json&#34;</span>)
</span></span><span style="display:flex;"><span>	w.<span style="color:#900;font-weight:bold">WriteHeader</span>(http.StatusOK)
</span></span><span style="display:flex;"><span>	json.<span style="color:#900;font-weight:bold">NewEncoder</span>(w).<span style="color:#900;font-weight:bold">Encode</span>(data)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">var</span> port = flag.<span style="color:#900;font-weight:bold">String</span>(<span style="color:#d14">&#34;port&#34;</span>, <span style="color:#d14">&#34;&#34;</span>, <span style="color:#d14">&#34;Port to listen on&#34;</span>)
</span></span><span style="display:flex;"><span>	flag.<span style="color:#900;font-weight:bold">Parse</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">*</span>port <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#0086b3">panic</span>(<span style="color:#d14">&#34;port is required&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	http.<span style="color:#900;font-weight:bold">HandleFunc</span>(<span style="color:#d14">&#34;/healthz&#34;</span>, <span style="color:#000;font-weight:bold">func</span>(w http.ResponseWriter, r <span style="color:#000;font-weight:bold">*</span>http.Request) {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">writeJsonResponse</span>(w, <span style="color:#000;font-weight:bold">map</span>[<span style="color:#458;font-weight:bold">string</span>]<span style="color:#458;font-weight:bold">string</span>{<span style="color:#d14">&#34;message&#34;</span>: <span style="color:#d14">&#34;ok&#34;</span>})
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	http.<span style="color:#900;font-weight:bold">ListenAndServe</span>(<span style="color:#d14">&#34;:&#34;</span><span style="color:#000;font-weight:bold">+*</span>port, <span style="color:#000;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>We can run a quick test:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>go build -o bluegreendemo cmd/main.go
</span></span><span style="display:flex;"><span>./bluegreendemo --port <span style="color:#099">8080</span> &amp;
</span></span><span style="display:flex;"><span>sleep <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>curl -s http://localhost:8080/healthz | jq
</span></span><span style="display:flex;"><span>pkill -f <span style="color:#d14">&#34;./bluegreendemo --port 8080&#34;</span>
</span></span></code></pre><p>You should see the health response:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#000080">&#34;message&#34;</span>: <span style="color:#d14">&#34;ok&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h3 id="create-a-local-vm-with-multipass">Create a local VM with multipass</h3>
<p>We will create a VM in our computer using multipass following the <a href="https://canonical.com/multipass/install">official docs</a>.</p>
<p>Our VM locally will have the following specs:</p>
<ul>
<li>Ubuntu 24.04</li>
<li>2 CPUs</li>
<li>4 GB of RAM</li>
<li>15GB of HD</li>
</ul>
<p>Feel free to tweak your numbers.</p>
<p>For example, for macOS with Homebrew you can just run:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>brew install multipass
</span></span><span style="display:flex;"><span>multipass launch 24.04 --name bluegreen-demo --cpus <span style="color:#099">2</span> --memory 4G --disk 15G
</span></span><span style="display:flex;"><span>multipass list
</span></span></code></pre><p>We should see that the machine is running:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>Name                    State             IPv4             Image
</span></span><span style="display:flex;"><span>bluegreen-demo          Running           192.168.64.8     Ubuntu 24.04 LTS
</span></span></code></pre><h3 id="deploy-and-start-the-application-in-the-vm">Deploy and start the application in the VM</h3>
<p>To handle our deployment process cleanly, we'll create three specialized scripts:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>cmd/
</span></span><span style="display:flex;"><span>    main.go
</span></span><span style="display:flex;"><span>scripts/
</span></span><span style="display:flex;"><span>    prepare.sh   # Handles building and file transfers
</span></span><span style="display:flex;"><span>    apply.sh     # Manages deployment in the VM
</span></span><span style="display:flex;"><span>    ci.sh        # Orchestrates the whole process
</span></span><span style="display:flex;"><span>go.mod
</span></span></code></pre><p>Make the scripts executable:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>chmod +x scripts/prepare.sh scripts/apply.sh scripts/ci.sh
</span></span></code></pre><p>Let's implement each script:</p>
<h4 id="preparesh---building-and-file-transfers">prepare.sh - Building and File Transfers</h4>
<p>This script handles the build process and transferring files to the VM:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#! /bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Cross-compile for Linux ARM64</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">GOOS</span><span style="color:#000;font-weight:bold">=</span>linux <span style="color:#008080">GOARCH</span><span style="color:#000;font-weight:bold">=</span>arm64 go build -o bluegreendemo cmd/main.go
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Transfer files to the VM</span>
</span></span><span style="display:flex;"><span>multipass transfer ./bluegreendemo bluegreen-demo:bluegreendemo
</span></span><span style="display:flex;"><span>multipass transfer ./scripts/apply.sh bluegreen-demo:apply.sh
</span></span></code></pre><h4 id="applysh---vm-side-deployment">apply.sh - VM-side Deployment</h4>
<p>This script runs inside the VM and handles the application deployment:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#! /bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Prepare app directory</span>
</span></span><span style="display:flex;"><span>sudo mkdir -p /app/
</span></span><span style="display:flex;"><span>sudo chown ubuntu:ubuntu /app/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Deploy application</span>
</span></span><span style="display:flex;"><span>mv bluegreendemo /app/app
</span></span><span style="display:flex;"><span>chmod +x /app/app
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Start the application</span>
</span></span><span style="display:flex;"><span>/app/app --port <span style="color:#099">8081</span> &amp;
</span></span></code></pre><h4 id="cish---orchestrating-the-process">ci.sh - Orchestrating the Process</h4>
<p>This script coordinates the whole deployment:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#! /bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;Preparing deployment...&#34;</span>
</span></span><span style="display:flex;"><span>./scripts/prepare.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;Deploying new version...&#34;</span>
</span></span><span style="display:flex;"><span>multipass <span style="color:#0086b3">exec</span> bluegreen-demo -- ./apply.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Verify deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">VM_IP</span><span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">$(</span>multipass info bluegreen-demo | grep IPv4 | awk <span style="color:#d14">&#39;{print $2}&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>curl -s http://<span style="color:#008080">$VM_IP</span>:8081/healthz | jq
</span></span></code></pre><p>Run the deployment:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>./scripts/ci.sh
</span></span></code></pre><p>If you see a JSON response with <code>{&quot;message&quot;: &quot;ok&quot;}</code>, congratulations! Your app is running.</p>
<h3 id="install-nginx">Install nginx</h3>
<p>We need to install and configure nginx in our VM:</p>
<ul>
<li>Install nginx</li>
<li>Start it and configure it to start on boot</li>
<li>Check the status</li>
</ul>
<p>For that we will open a shell in the VM using <code>multipass shell bluegreen-demo</code> and run the following set of commands:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>sudo apt update
</span></span><span style="display:flex;"><span>sudo apt install nginx -y
</span></span><span style="display:flex;"><span>nginx -v
</span></span><span style="display:flex;"><span>sudo systemctl start nginx
</span></span><span style="display:flex;"><span>sudo systemctl <span style="color:#0086b3">enable</span> nginx
</span></span><span style="display:flex;"><span>sudo systemctl status nginx
</span></span></code></pre><p>At the end of the script you should see something like:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>Sep 13 10:26:14 bluegreen-demo systemd[1]: Starting nginx.service - A high performance web server and a reverse proxy server...
</span></span><span style="display:flex;"><span>Sep 13 10:26:14 bluegreen-demo systemd[1]: Started nginx.service - A high performance web server and a reverse proxy server.
</span></span></code></pre><h3 id="configure-nginx-to-serve-our-application">Configure nginx to serve our application</h3>
<p>We will configure nginx to serve our application in port 80 (default for http). For that we will create a minimum nginx.conf file to listen to port 80 and forward the requests to our app in port 8081.</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>cmd/
</span></span><span style="display:flex;"><span>    main.go
</span></span><span style="display:flex;"><span>nginx/
</span></span><span style="display:flex;"><span>    nginx.conf &lt;-- this file
</span></span><span style="display:flex;"><span>scripts/
</span></span><span style="display:flex;"><span>    apply.sh
</span></span><span style="display:flex;"><span>    ci.sh
</span></span><span style="display:flex;"><span>    prepare.sh
</span></span><span style="display:flex;"><span>go.mod
</span></span></code></pre><p>These are the contents:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">worker_connections</span> <span style="color:#099">1024</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">include</span> <span style="color:#d14">/etc/nginx/mime.types</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">listen</span> <span style="color:#099">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">server_name</span> <span style="color:#d14">_</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">location</span> <span style="color:#d14">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">proxy_pass</span> <span style="color:#d14">http://localhost:8081</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>We will need to update our scripts to handle the nginx configuration:</p>
<ol>
<li>Add nginx.conf transfer to <code>prepare.sh</code>:</li>
</ol>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>multipass transfer ./nginx/nginx.conf bluegreen-demo:nginx/nginx.conf
</span></span></code></pre><ol start="2">
<li>Add nginx configuration to <code>apply.sh</code>:</li>
</ol>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>sudo mv nginx/nginx.conf /etc/nginx/nginx.conf
</span></span><span style="display:flex;"><span>sudo nginx -s reload
</span></span></code></pre><p>Let's try it out by running:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>./scripts/ci.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Now we should be able to access our app using the port 80:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#d14">```</span>shell
</span></span><span style="display:flex;"><span><span style="color:#008080">VM_IP</span><span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">$(</span>multipass info bluegreen-demo | grep IPv4 | awk <span style="color:#d14">&#39;{print $2}&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -s http://<span style="color:#008080">$VM_IP</span>/healthz | jq
</span></span></code></pre><p>We have nginx serving our app.</p>
<h2 id="block-2-configure-blue-green-deployment">Block 2: Configure blue green deployment</h2>
<p>Let's implement a blue-green deployment strategy that allows us to deploy new versions without downtime. The idea is simple:</p>
<ul>
<li>Run two instances of our application (blue and green)</li>
<li>Only one instance receives traffic at a time</li>
<li>Deploy new versions to the inactive instance</li>
<li>Switch traffic to the new version once it's ready</li>
</ul>
<p>Here's how it works:</p>
<svg width="800" height="300" xmlns="http://www.w3.org/2000/svg">
        <!-- Background -->
        <rect width="800" height="300" fill="#ffffff"/>
        
        
<g transform="translate(50.000000,10.000000)">
    <g class="ns" filter="url(#softShadow)">
            <rect x="0" y="0" width="250.000000" height="200.000000" rx="3.906250" fill="#e6f3ff" stroke="rgb(0, 119, 194)"/>
            <rect x="0" y="0" width="250.000000" height="20.952380" rx="3.906250" ry="3.906250" fill="#e6f3ff" stroke="rgb(0, 119, 194)"/>
            <rect x="39.062500" y="4.761900" width="187.500000" height="11.428560" rx="2.343750" fill="#fff" stroke="rgb(0, 119, 194)" opacity="0.85"/>
            <rect x="4.687500" y="26.666660" width="240.625000" height="167.619040" rx="2.343750" fill="#ffffff" stroke="rgb(0, 119, 194)" opacity="0.9"/>
    </g>
    <text x="132.812500" y="10.476180" text-anchor="middle" dominant-baseline="middle"
            font-family="-apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"
            font-size="10.000000" fill="rgb(0, 119, 194)">http://multipass/home</text>
    <text x="125.000000" y="110.476180" text-anchor="middle" dominant-baseline="middle"
            font-family="-apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"
            font-size="25" fill="rgb(0, 119, 194)">Blue</text>
    
<g transform="translate(5.468750,6.666660)">
        <circle r="2.343750" cx="0" cy="3.117188" fill="#ff5f57"/>
        <circle r="2.343750" cx="7.031250" cy="3.117188" fill="#febc2e"/>
        <circle r="2.343750" cx="14.062500" cy="3.117188" fill="#28c840"/>
</g>


</g>

<g transform="translate(350.000000,10.000000)">
        <g class="ns" filter="url(#softShadow)">
                <rect x="0" y="0" width="400.000000" height="200.000000" rx="6.250000" fill="#666" stroke="#eee"/>
                <rect x="0" y="0" width="400.000000" height="20.952380" rx="6.250000" ry="6.250000" fill="#666" stroke="#eee"/>
                <rect x="7.500000" y="26.666660" width="385.000000" height="167.619040" rx="3.750000" fill="#f0f8ff" stroke="#eee" opacity="0.9"/>
        </g>    
        
        
        <text x="62.500000" 
                y="10.761900" 
                text-anchor="start" 
                dominant-baseline="middle"
                font-family="-apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"
                font-size="14.000000000000002" 
                fill="#eee">ubuntu@multipass</text>
        
<g transform="translate(8.750000,6.666660)">
        <circle r="3.750000" cx="0" cy="4.987500" fill="#ff5f57"/>
        <circle r="3.750000" cx="11.250000" cy="4.987500" fill="#febc2e"/>
        <circle r="3.750000" cx="22.500000" cy="4.987500" fill="#28c840"/>
</g>


        <g transform="translate(7.500000,26.666660)" class="vm-content">
<g transform="translate(20.000000,53.333340)">
    
    <rect x="0" y="0" width="150.000000" height="40.000000"
          rx="4.000000" ry="4.000000"
          fill="#f0f8ff" stroke="#333" stroke-width="2"/>

    
    
    
    <g transform="translate(6.000000,6.000000)">
        
        
        <rect x="0" y="0" width="28.000000" height="28.000000" fill="#009639"/>
        <text x="14.000000" y="19.600000"
              fill="#ffffff" font-family="Arial" font-size="16.800000"
              text-anchor="middle">N</text>
        
    </g>

    
    <text x="46.000000"
          y="24.000000"
          fill="#333"
          font-family="Arial"
          font-size="16.000000"
          >nginx</text>

    
    <text x="144.000000"
          y="24.000000"
          fill="#333"
          font-family="Arial"
          font-size="14.000000"
          text-anchor="end">:80</text>
</g>

<g transform="translate(200.000000,53.333340)">
    
    <rect x="0" y="0" width="150.000000" height="40.000000"
          rx="4.000000" ry="4.000000"
          fill="rgb(0, 119, 194)" stroke="#fff" stroke-width="2"/>

    
    
    
    <g transform="translate(6.000000,6.000000)">
        
        
        <rect x="0" y="0" width="28.000000" height="28.000000" fill="#00ADD8"/>
        <text x="14.000000" y="19.600000"
              fill="#ffffff" font-family="Arial" font-size="16.800000"
              text-anchor="middle">Go</text>
        
    </g>

    
    <text x="46.000000"
          y="24.000000"
          fill="#fff"
          font-family="Arial"
          font-size="16.000000"
          >blue</text>

    
    <text x="144.000000"
          y="24.000000"
          fill="#fff"
          font-family="Arial"
          font-size="14.000000"
          text-anchor="end">:8081</text>
</g>

<g transform="translate(200.000000,110.000000)">
    
    <rect x="0" y="0" width="150.000000" height="40.000000"
          rx="4.000000" ry="4.000000"
          fill="rgb(0, 118, 108)" stroke="#fff" stroke-width="2"/>

    
    
    
    <g transform="translate(6.000000,6.000000)">
        
        
        <rect x="0" y="0" width="28.000000" height="28.000000" fill="#00ADD8"/>
        <text x="14.000000" y="19.600000"
              fill="#ffffff" font-family="Arial" font-size="16.800000"
              text-anchor="middle">Go</text>
        
    </g>

    
    <text x="46.000000"
          y="24.000000"
          fill="#fff"
          font-family="Arial"
          font-size="16.000000"
          >green</text>

    
    <text x="144.000000"
          y="24.000000"
          fill="#fff"
          font-family="Arial"
          font-size="14.000000"
          text-anchor="end">:8082</text>
</g>
</g>
</g>

<g class="connector">
    <defs>
        <marker id="arrowhead-21" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#1f2937"/>
        </marker>
    </defs>
    <polyline
        points="300.00,110.00 377.50,110.00" stroke="#1f2937" stroke-width="2.00" fill="none" stroke-linecap="round" stroke-linejoin="round" marker-end="url(#arrowhead-21)"
    />
</g>

<g class="connector">
    <defs>
        <marker id="arrowhead-22" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#1f2937"/>
        </marker>
    </defs>
    <polyline
        points="527.50,110.00 557.50,110.00" stroke="#1f2937" stroke-width="2.00" fill="none" stroke-linecap="round" stroke-linejoin="round" marker-end="url(#arrowhead-22)"
    />
</g>

</svg><p>And after deploying and switching:</p>
<svg width="800" height="300" xmlns="http://www.w3.org/2000/svg">
        <!-- Background -->
        <rect width="800" height="300" fill="#ffffff"/>
        
        
<g transform="translate(50.000000,10.000000)">
    <g class="ns" filter="url(#softShadow)">
            <rect x="0" y="0" width="250.000000" height="200.000000" rx="3.906250" fill="#e6f3ff" stroke="rgb(0, 118, 108)"/>
            <rect x="0" y="0" width="250.000000" height="20.952380" rx="3.906250" ry="3.906250" fill="#e6f3ff" stroke="rgb(0, 118, 108)"/>
            <rect x="39.062500" y="4.761900" width="187.500000" height="11.428560" rx="2.343750" fill="#fff" stroke="rgb(0, 118, 108)" opacity="0.85"/>
            <rect x="4.687500" y="26.666660" width="240.625000" height="167.619040" rx="2.343750" fill="#ffffff" stroke="rgb(0, 118, 108)" opacity="0.9"/>
    </g>
    <text x="132.812500" y="10.476180" text-anchor="middle" dominant-baseline="middle"
            font-family="-apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"
            font-size="10.000000" fill="rgb(0, 118, 108)">http://multipass/home</text>
    <text x="125.000000" y="110.476180" text-anchor="middle" dominant-baseline="middle"
            font-family="-apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"
            font-size="25" fill="rgb(0, 118, 108)">Green</text>
    
<g transform="translate(5.468750,6.666660)">
        <circle r="2.343750" cx="0" cy="3.117188" fill="#ff5f57"/>
        <circle r="2.343750" cx="7.031250" cy="3.117188" fill="#febc2e"/>
        <circle r="2.343750" cx="14.062500" cy="3.117188" fill="#28c840"/>
</g>


</g>

<g transform="translate(350.000000,10.000000)">
        <g class="ns" filter="url(#softShadow)">
                <rect x="0" y="0" width="400.000000" height="200.000000" rx="6.250000" fill="#666" stroke="#eee"/>
                <rect x="0" y="0" width="400.000000" height="20.952380" rx="6.250000" ry="6.250000" fill="#666" stroke="#eee"/>
                <rect x="7.500000" y="26.666660" width="385.000000" height="167.619040" rx="3.750000" fill="#f0f8ff" stroke="#eee" opacity="0.9"/>
        </g>    
        
        
        <text x="62.500000" 
                y="10.761900" 
                text-anchor="start" 
                dominant-baseline="middle"
                font-family="-apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"
                font-size="14.000000000000002" 
                fill="#eee">ubuntu@multipass</text>
        
<g transform="translate(8.750000,6.666660)">
        <circle r="3.750000" cx="0" cy="4.987500" fill="#ff5f57"/>
        <circle r="3.750000" cx="11.250000" cy="4.987500" fill="#febc2e"/>
        <circle r="3.750000" cx="22.500000" cy="4.987500" fill="#28c840"/>
</g>


        <g transform="translate(7.500000,26.666660)" class="vm-content">
<g transform="translate(20.000000,53.333340)">
    
    <rect x="0" y="0" width="150.000000" height="40.000000"
          rx="4.000000" ry="4.000000"
          fill="#f0f8ff" stroke="#333" stroke-width="2"/>

    
    
    
    <g transform="translate(6.000000,6.000000)">
        
        
        <rect x="0" y="0" width="28.000000" height="28.000000" fill="#009639"/>
        <text x="14.000000" y="19.600000"
              fill="#ffffff" font-family="Arial" font-size="16.800000"
              text-anchor="middle">N</text>
        
    </g>

    
    <text x="46.000000"
          y="24.000000"
          fill="#333"
          font-family="Arial"
          font-size="16.000000"
          >nginx</text>

    
    <text x="144.000000"
          y="24.000000"
          fill="#333"
          font-family="Arial"
          font-size="14.000000"
          text-anchor="end">:80</text>
</g>

<g transform="translate(200.000000,110.000000)">
    
    <rect x="0" y="0" width="150.000000" height="40.000000"
          rx="4.000000" ry="4.000000"
          fill="rgb(0, 119, 194)" stroke="#fff" stroke-width="2"/>

    
    
    
    <g transform="translate(6.000000,6.000000)">
        
        
        <rect x="0" y="0" width="28.000000" height="28.000000" fill="#00ADD8"/>
        <text x="14.000000" y="19.600000"
              fill="#ffffff" font-family="Arial" font-size="16.800000"
              text-anchor="middle">Go</text>
        
    </g>

    
    <text x="46.000000"
          y="24.000000"
          fill="#fff"
          font-family="Arial"
          font-size="16.000000"
          >blue</text>

    
    <text x="144.000000"
          y="24.000000"
          fill="#fff"
          font-family="Arial"
          font-size="14.000000"
          text-anchor="end">:8081</text>
</g>

<g transform="translate(200.000000,53.333340)">
    
    <rect x="0" y="0" width="150.000000" height="40.000000"
          rx="4.000000" ry="4.000000"
          fill="rgb(0, 118, 108)" stroke="#fff" stroke-width="2"/>

    
    
    
    <g transform="translate(6.000000,6.000000)">
        
        
        <rect x="0" y="0" width="28.000000" height="28.000000" fill="#00ADD8"/>
        <text x="14.000000" y="19.600000"
              fill="#ffffff" font-family="Arial" font-size="16.800000"
              text-anchor="middle">Go</text>
        
    </g>

    
    <text x="46.000000"
          y="24.000000"
          fill="#fff"
          font-family="Arial"
          font-size="16.000000"
          >green</text>

    
    <text x="144.000000"
          y="24.000000"
          fill="#fff"
          font-family="Arial"
          font-size="14.000000"
          text-anchor="end">:8082</text>
</g>
</g>
</g>

<g class="connector">
    <defs>
        <marker id="arrowhead-25" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#1f2937"/>
        </marker>
    </defs>
    <polyline
        points="300.00,110.00 377.50,110.00" stroke="#1f2937" stroke-width="2.00" fill="none" stroke-linecap="round" stroke-linejoin="round" marker-end="url(#arrowhead-25)"
    />
</g>

<g class="connector">
    <defs>
        <marker id="arrowhead-26" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#1f2937"/>
        </marker>
    </defs>
    <polyline
        points="527.50,110.00 557.50,110.00" stroke="#1f2937" stroke-width="2.00" fill="none" stroke-linecap="round" stroke-linejoin="round" marker-end="url(#arrowhead-26)"
    />
</g>

</svg><h3 id="adding-color-support-to-our-server">Adding Color Support to Our Server</h3>
<p>First, let's enhance our Go server to identify which version (blue or green) it is:</p>
<ul>
<li>Add a <code>--color</code> flag to identify blue/green instances</li>
<li>Add a <code>/status</code> endpoint to report the current color</li>
</ul>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#d14">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d14">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d14">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">writeJsonResponse</span>(w http.ResponseWriter, data <span style="color:#000;font-weight:bold">map</span>[<span style="color:#458;font-weight:bold">string</span>]<span style="color:#458;font-weight:bold">string</span>) {
</span></span><span style="display:flex;"><span>	w.<span style="color:#900;font-weight:bold">Header</span>().<span style="color:#900;font-weight:bold">Set</span>(<span style="color:#d14">&#34;Content-Type&#34;</span>, <span style="color:#d14">&#34;application/json&#34;</span>)
</span></span><span style="display:flex;"><span>	w.<span style="color:#900;font-weight:bold">WriteHeader</span>(http.StatusOK)
</span></span><span style="display:flex;"><span>	json.<span style="color:#900;font-weight:bold">NewEncoder</span>(w).<span style="color:#900;font-weight:bold">Encode</span>(data)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">var</span> port = flag.<span style="color:#900;font-weight:bold">String</span>(<span style="color:#d14">&#34;port&#34;</span>, <span style="color:#d14">&#34;&#34;</span>, <span style="color:#d14">&#34;Port to listen on&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// NEW: Get &#34;color&#34; as arg when the server starts
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">var</span> color = flag.<span style="color:#900;font-weight:bold">String</span>(<span style="color:#d14">&#34;color&#34;</span>, <span style="color:#d14">&#34;&#34;</span>, <span style="color:#d14">&#34;Color value to return in responses&#34;</span>)
</span></span><span style="display:flex;"><span>	flag.<span style="color:#900;font-weight:bold">Parse</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">*</span>port <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;&#34;</span> <span style="color:#000;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">*</span>color <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#0086b3">panic</span>(<span style="color:#d14">&#34;port and color are required&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	http.<span style="color:#900;font-weight:bold">HandleFunc</span>(<span style="color:#d14">&#34;/healthz&#34;</span>, <span style="color:#000;font-weight:bold">func</span>(w http.ResponseWriter, r <span style="color:#000;font-weight:bold">*</span>http.Request) {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">writeJsonResponse</span>(w, <span style="color:#000;font-weight:bold">map</span>[<span style="color:#458;font-weight:bold">string</span>]<span style="color:#458;font-weight:bold">string</span>{<span style="color:#d14">&#34;message&#34;</span>: <span style="color:#d14">&#34;ok&#34;</span>})
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// NEW: Return the &#34;color&#34; in the status endpoint
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	http.<span style="color:#900;font-weight:bold">HandleFunc</span>(<span style="color:#d14">&#34;/status&#34;</span>, <span style="color:#000;font-weight:bold">func</span>(w http.ResponseWriter, r <span style="color:#000;font-weight:bold">*</span>http.Request) {
</span></span><span style="display:flex;"><span>		<span style="color:#900;font-weight:bold">writeJsonResponse</span>(w, <span style="color:#000;font-weight:bold">map</span>[<span style="color:#458;font-weight:bold">string</span>]<span style="color:#458;font-weight:bold">string</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#d14">&#34;color&#34;</span>: <span style="color:#000;font-weight:bold">*</span>color,
</span></span><span style="display:flex;"><span>		})
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	http.<span style="color:#900;font-weight:bold">ListenAndServe</span>(<span style="color:#d14">&#34;:&#34;</span><span style="color:#000;font-weight:bold">+*</span>port, <span style="color:#000;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h3 id="updating-the-deployment-scripts-for-blue-green">Updating the Deployment Scripts for Blue-Green</h3>
<p>Now that we've added color support to our server, we need to update our existing deployment scripts to handle the blue-green deployment strategy. Let's modify each script to support this new functionality:</p>
<h4 id="updates-to-preparesh">Updates to prepare.sh</h4>
<p>We'll update our existing <code>prepare.sh</code> script to handle the nginx configuration files for blue-green deployment:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#! /bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Cross-compile for Linux ARM64</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">GOOS</span><span style="color:#000;font-weight:bold">=</span>linux <span style="color:#008080">GOARCH</span><span style="color:#000;font-weight:bold">=</span>arm64 go build -o bluegreendemo cmd/main.go
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Transfer all required files to the VM</span>
</span></span><span style="display:flex;"><span>multipass transfer ./bluegreendemo bluegreen-demo:bluegreendemo
</span></span><span style="display:flex;"><span>multipass transfer ./nginx/nginx.conf bluegreen-demo:nginx/nginx.conf
</span></span><span style="display:flex;"><span>multipass transfer ./scripts/apply.sh bluegreen-demo:apply.sh
</span></span></code></pre><h4 id="updates-to-applysh">Updates to apply.sh</h4>
<p>We'll enhance our existing <code>apply.sh</code> script to handle the blue-green deployment logic:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#! /bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Get current active color</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">CURRENT_COLOR</span><span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">$(</span>curl -s http://localhost/status | jq -r .color<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Determine next deployment color</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">[</span> <span style="color:#d14">&#34;</span><span style="color:#008080">$CURRENT_COLOR</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;blue&#34;</span> <span style="color:#000;font-weight:bold">]</span>; <span style="color:#000;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#008080">NEXT_COLOR</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;green&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#008080">NEXT_PORT</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;8082&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#008080">NEXT_COLOR</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;blue&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#008080">NEXT_PORT</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;8081&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;Deploying </span><span style="color:#008080">$NEXT_COLOR</span><span style="color:#d14"> on port </span><span style="color:#008080">$NEXT_PORT</span><span style="color:#d14">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Prepare deployment</span>
</span></span><span style="display:flex;"><span>sudo mkdir -p /app/
</span></span><span style="display:flex;"><span>sudo chown ubuntu:ubuntu /app/
</span></span><span style="display:flex;"><span>pkill -f /app/<span style="color:#008080">$NEXT_COLOR</span> <span style="color:#000;font-weight:bold">||</span> <span style="color:#0086b3">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Deploy new version</span>
</span></span><span style="display:flex;"><span>mv bluegreendemo /app/<span style="color:#008080">$NEXT_COLOR</span>
</span></span><span style="display:flex;"><span>chmod +x /app/<span style="color:#008080">$NEXT_COLOR</span>
</span></span><span style="display:flex;"><span>/app/<span style="color:#008080">$NEXT_COLOR</span> --port <span style="color:#008080">$NEXT_PORT</span> --color <span style="color:#008080">$NEXT_COLOR</span> &amp;
</span></span><span style="display:flex;"><span>sleep <span style="color:#099">2</span>  <span style="color:#998;font-style:italic"># Wait for startup</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Verify deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">if</span> curl -s http://localhost:<span style="color:#008080">$NEXT_PORT</span>/status | grep -q <span style="color:#d14">&#34;</span><span style="color:#008080">$NEXT_COLOR</span><span style="color:#d14">&#34;</span>; <span style="color:#000;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># Switch traffic</span>
</span></span><span style="display:flex;"><span>    sudo mv *.conf /etc/nginx/
</span></span><span style="display:flex;"><span>    sudo ln -sf /etc/nginx/<span style="color:#008080">$NEXT_COLOR</span>.conf /etc/nginx/upstream.conf
</span></span><span style="display:flex;"><span>    sudo nginx -s reload
</span></span><span style="display:flex;"><span>    <span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;Switched to </span><span style="color:#008080">$NEXT_COLOR</span><span style="color:#d14">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;Deployment failed - new version not responding&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0086b3">exit</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">fi</span>
</span></span></code></pre><h4 id="updates-to-cish">Updates to ci.sh</h4>
<p>We'll update our existing <code>ci.sh</code> script to handle the verification of the deployment switch:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#! /bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;Preparing deployment...&#34;</span>
</span></span><span style="display:flex;"><span>./scripts/prepare.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;Deploying new version...&#34;</span>
</span></span><span style="display:flex;"><span>multipass <span style="color:#0086b3">exec</span> bluegreen-demo -- ./apply.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Verify the switch</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">VM_IP</span><span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">$(</span>multipass info bluegreen-demo | grep IPv4 | awk <span style="color:#d14">&#39;{print $2}&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;Current version:&#34;</span>
</span></span><span style="display:flex;"><span>curl -s http://<span style="color:#008080">$VM_IP</span>/status | jq
</span></span></code></pre><p>If we run the ci again we should find this line:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>./scripts/ci.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Deployment failed! Current color is still blue
</span></span></code></pre><p>If we check from the host:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#008080">VM_IP</span><span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">$(</span>multipass info bluegreen-demo | grep IPv4 | awk <span style="color:#d14">&#39;{print $2}&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;Checking green&#34;</span>
</span></span><span style="display:flex;"><span>curl -s http://<span style="color:#008080">$VM_IP</span>:8082/status | jq -r .color
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;Checking default&#34;</span>
</span></span><span style="display:flex;"><span>curl -s http://<span style="color:#008080">$VM_IP</span>/status | jq -r .color
</span></span></code></pre><p>We should see:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>Checking green
</span></span><span style="display:flex;"><span>green
</span></span><span style="display:flex;"><span>Checking default
</span></span><span style="display:flex;"><span>blue
</span></span></code></pre><p>Green is running properly but nginx still points to <code>blue</code> (we hardcoded it, remember?)</p>
<h3 id="configuring-nginx-for-zero-downtime-switching">Configuring Nginx for Zero-Downtime Switching</h3>
<p>The final piece is setting up nginx to smoothly switch between versions. The key is to use nginx's upstream feature and symbolic links to make the switch instant and atomic.</p>
<h4 id="1-setting-up-the-configuration-structure">1. Setting up the Configuration Structure</h4>
<p>We'll create three configuration files:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>nginx/
</span></span><span style="display:flex;"><span>    nginx.conf         # Main configuration with routing logic
</span></span><span style="display:flex;"><span>    blue.conf          # Blue instance configuration (port 8081)
</span></span><span style="display:flex;"><span>    green.conf         # Green instance configuration (port 8082)
</span></span></code></pre><h4 id="2-creating-instance-specific-configs">2. Creating Instance-Specific Configs</h4>
<p>Each color gets its own configuration that defines where its instance runs:</p>
<p><code>blue.conf</code>:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">upstream</span> <span style="color:#d14">app_backend</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">server</span> 127.0.0.1:<span style="color:#099">8081</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p><code>green.conf</code>:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">upstream</span> <span style="color:#d14">app_backend</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">server</span> 127.0.0.1:<span style="color:#099">8082</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h4 id="3-setting-up-the-main-configuration">3. Setting up the Main Configuration</h4>
<p>Update <code>nginx.conf</code> to use the dynamic backend:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#000;font-weight:bold">events</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">worker_connections</span> <span style="color:#099">1024</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">include</span> <span style="color:#d14">/etc/nginx/mime.types</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">include</span> <span style="color:#d14">/etc/nginx/upstream.conf</span>;  <span style="color:#998;font-style:italic"># Dynamic backend selection
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">listen</span> <span style="color:#099">80</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">server_name</span> <span style="color:#d14">_</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">location</span> <span style="color:#d14">/</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">proxy_pass</span> <span style="color:#d14">http://app_backend</span>;  <span style="color:#998;font-style:italic"># Routes to active instance
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h4 id="4-implementing-the-switch-mechanism">4. Implementing the Switch Mechanism</h4>
<p>The switching mechanism is simple but effective:</p>
<ol>
<li>
<p>Upload the configuration:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>multipass transfer ./nginx/nginx.conf bluegreen-demo:nginx/nginx.conf
</span></span></code></pre></li>
<li>
<p>Set up the active configuration using a symbolic link:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span>sudo mv *.conf /etc/nginx/
</span></span><span style="display:flex;"><span>sudo ln -sf /etc/nginx/<span style="color:#008080">$NEXT_COLOR</span>.conf /etc/nginx/upstream.conf
</span></span><span style="display:flex;"><span>sudo nginx -s reload
</span></span></code></pre></li>
</ol>
<p>This setup gives us two key benefits:</p>
<ul>
<li><strong>Zero Downtime</strong>: The switch is instant and atomic</li>
<li><strong>Easy Rollback</strong>: We can quickly switch back by changing the symbolic link</li>
</ul>
<p>If we run our ci again and again we should be seeing our color changing from green to blue:</p>
<pre tabindex="0" style="background-color:#fff;"><code><span style="display:flex;"><span><span style="color:#008080">VM_IP</span><span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">$(</span>multipass info bluegreen-demo | grep IPv4 | awk <span style="color:#d14">&#39;{print $2}&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>./scripts/ci.sh
</span></span><span style="display:flex;"><span>curl -s http://<span style="color:#008080">$VM_IP</span>/status | jq -r .color
</span></span></code></pre><h3 id="conclusion">Conclusion</h3>
<p>We've successfully created a simple but effective blue-green deployment system that:</p>
<ul>
<li>Enables zero-downtime deployments on a single VPS</li>
<li>Uses nginx for instant traffic switching</li>
<li>Keeps the previous version ready for quick rollbacks</li>
<li>Requires minimal infrastructure</li>
</ul>
<p>This approach shows how we can adapt modern deployment practices to a lean, cost-effective setup inspired by <a href="https://x.com/levelsio?lang=en">levelsio</a>'s philosophy. While this example uses Go, the same principles can work with any compiled language.</p>
<h4 id="next-steps">Next Steps</h4>
<p>In the upcoming post, we'll take this solution further by:</p>
<ul>
<li>Integrating it with GitHub Actions for automated deployments</li>
<li>Adding Cloudflare on top of our server to minimize the amount of traffic and process the app has to perform</li>
</ul>
<p>Stay tuned to see how we can make this simple setup even more robust!</p>

  </article>
  <div>
    
    
  </div>
</div>
</div>

      <footer>
        <div>
          <p>&copy; 2025 . All rights reserved.</p>
        </div>
      </footer>
    </main>
  </body>
</html>
